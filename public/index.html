<!DOCTYPE html>

<html lang="en">
<head>
<link href="/Circle.icon.ico" rel="icon" type="image/x-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Jaice — Research Q&amp;A</title>
<link href="/styles.css" rel="stylesheet"/>
<style>
    :root {
      --jaice-orange: #D14829;
      --text-primary: #1c1d1f;
      --text-muted: #666;
      --logo-grey: #6b7280;
      --background: #ffffff;
      --border: #e0e4e7;
      --white: #fff;
      --shadow-soft: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* CHATGPT-STYLE SIDEBAR LAYOUT */
    .app-layout {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: white;
      position: relative;
    }

    /* Sidebar - ChatGPT style - Override modern-bridge.css */
    .sidebar {
      position: fixed !important;
      top: 70px !important; /* Position under header */
      left: 0 !important;
      width: 280px !important; /* Increased from 260px for more space */
      height: calc(100vh - 70px) !important; /* Subtract header height */
      background: #58595B !important; /* Dark grey as requested */
      border: none !important; /* Remove ALL borders */
      transform: translateX(-240px) !important; /* Show 40px edge by default, adjusted for new width */
      transition: transform 0.3s ease !important;
      z-index: 999 !important; /* Lower than header */
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15) !important; /* Added shadow effect */
      display: flex !important;
      flex-direction: column !important;
      color: white !important; /* White text on dark background */
      outline: none !important; /* Remove any outline */
    }

    /* Ensure no borders in any state */
    .sidebar:hover,
    .sidebar:focus,
    .sidebar:active,
    .sidebar.pinned {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }

    .sidebar:hover,
    .sidebar.pinned {
      transform: translateX(0) !important;
    }

    /* Custom sidebar icon - always visible in the edge area */
    .sidebar-icon {
      position: absolute !important;
      top: 16px !important;
      right: 6px !important; /* Centered in the 40px visible area: (40px - 28px) / 2 = 6px */
      width: 28px !important;
      height: 24px !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      color: white !important;
      border-radius: 6px !important;
      padding: 4px !important;
      z-index: 10 !important;
      background-color: rgba(255, 255, 255, 0.05) !important; /* Subtle background for visibility */
    }

    .sidebar-icon:hover {
      background-color: rgba(255, 255, 255, 0.1) !important;
    }

    /* Icon follows sidebar animation - stays in same relative position */
    .sidebar-icon svg {
      display: block !important;
      width: 100% !important;
      height: 100% !important;
    }

    /* Sidebar content */
    .sidebar-content {
      padding: 20px 16px !important;
      display: flex !important;
      flex-direction: column !important;
      height: 100% !important;
      overflow: hidden !important;
      flex: 1 !important;
      border: none !important;
      margin: 0 !important;
      outline: none !important;
      box-shadow: none !important;
    }

    /* Remove borders from ALL sidebar children */
    .sidebar *,
    .sidebar *:before,
    .sidebar *:after,
    .sidebar *:hover,
    .sidebar *:focus,
    .sidebar *:active {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }

    /* Override any external CSS that might add borders */
    .sidebar,
    .sidebar::before,
    .sidebar::after {
      border-left: none !important;
      border-right: none !important;
      border-top: none !important;
      border-bottom: none !important;
      border: none !important;
    }

    .sidebar-section {
      display: flex !important;
      flex-direction: column !important;
      overflow: hidden !important;
    }

    .sidebar-section.recent-searches {
      flex: 1 !important;
      margin-bottom: 20px !important;
      min-height: 0 !important;
    }

    .sidebar-section.reports {
      flex: 1 !important;
      min-height: 0 !important;
    }

    .sidebar-section-content {
      flex: 1 !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      min-height: 0 !important;
      padding-left: 8px !important;
      padding-right: 4px !important;
      direction: rtl !important; /* Right-to-left to move scrollbar to left */
    }

    .sidebar-section-content > div {
      direction: ltr !important; /* Reset content direction back to normal */
    }

    .sidebar-section-content::-webkit-scrollbar {
      width: 4px !important;
    }

    .sidebar-section-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1) !important;
      border-radius: 2px !important;
    }

    .sidebar-section-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3) !important;
      border-radius: 2px !important;
    }

    .sidebar-section-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5) !important;
    }

    .sidebar-section h3 {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: rgba(255, 255, 255, 0.9) !important;
      margin-bottom: 12px !important;
      text-transform: uppercase !important;
      letter-spacing: 0.8px !important;
      padding-bottom: 6px !important;
      flex-shrink: 0 !important;
      position: relative !important;
      border-bottom: none !important;
    }

    .sidebar-section h3::after {
      content: '' !important;
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 50px !important; /* Stop 50px from the right edge to avoid showing when closed */
      height: 1px !important;
      background: rgba(255, 255, 255, 0.15) !important;
    }

    .sidebar-item {
      display: block !important;
      padding: 10px 12px !important;
      color: rgba(255, 255, 255, 0.85) !important;
      text-decoration: none !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      line-height: 1.4 !important;
      margin-bottom: 6px !important;
      transition: all 0.2s ease !important;
      cursor: pointer !important;
      border: 1px solid transparent !important;
      position: relative !important;
    }

    .sidebar-item:hover {
      background-color: rgba(255, 255, 255, 0.08) !important;
      border-color: rgba(255, 255, 255, 0.2) !important;
      color: white !important;
      transform: translateX(2px) !important;
    }

    .sidebar-item.active {
      background-color: var(--jaice-orange) !important;
      border-color: var(--jaice-orange) !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(209, 72, 41, 0.3) !important;
    }

    .sidebar-item-subtitle {
      font-size: 11px !important;
      color: rgba(255, 255, 255, 0.6) !important;
      margin-top: 4px !important;
      font-weight: 400 !important;
    }

    .sidebar-item[style*="opacity: 0.6"] {
      font-style: italic !important;
      text-align: center !important;
      padding: 20px 12px !important;
      color: rgba(255, 255, 255, 0.5) !important;
    }

    /* Truncate search text to 2 lines */
    .sidebar-item-text {
      display: -webkit-box !important;
      -webkit-line-clamp: 2 !important;
      -webkit-box-orient: vertical !important;
      overflow: hidden !important;
      line-height: 1.4 !important;
      max-height: 2.8em !important; /* 2 lines * 1.4 line-height */
      word-break: break-word !important;
    }

    /* Adjust main content to account for sidebar */
    .main-content {
      flex: 1 !important;
      margin-top: 70px !important; /* Below header */
      margin-left: 40px !important; /* Space for closed sidebar edge - now 40px */
      display: flex !important;
      flex-direction: column !important;
      min-height: calc(100vh - 70px) !important;
      background: white !important;
      transition: margin-left 0.3s ease !important;
    }

    .sidebar.pinned ~ .main-content {
      margin-left: 260px !important;
    }

    /* NEW HEADER DESIGN - Full width with centered navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      box-shadow: var(--shadow-soft);
    }

    /* Logo on left */
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-primary);
      flex-shrink: 0;
    }

    .logo img {
      height: 32px;
      width: auto;
    }

    .beta-badge {
      background: transparent;
      border: 1px solid #9ca3af;
      color: #6b7280;
      font-size: 8px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: none;
    }

    /* CENTERED NAVIGATION */
    .main-nav {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
    }

    .nav-link:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    .nav-link.active {
      color: var(--jaice-orange);
      font-weight: 600;
      border-bottom: 2px solid var(--jaice-orange);
    }

    /* Right side - user info and profile */
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1001;
      flex-shrink: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .profile {
      position: relative;
      z-index: 1002;
    }

    .profile-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .profile-btn:hover {
      background: #f8f9fa;
      border-color: var(--jaice-orange);
    }

    .profile-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
      min-width: 180px;
      z-index: 1003;
      display: none;
      overflow: hidden;
    }

    .profile-menu.show {
      display: block;
    }

    .profile-menu a,
    .profile-menu button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .profile-menu a:hover,
    .profile-menu button:hover {
      background: #f8f9fa;
    }

    .company-name {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Client Selector */
    .client-selector-corner {
      position: fixed;
      top: 80px;
      right: 32px;
      z-index: 999;
      display: none;
    }

    .client-selector-corner.show {
      display: block;
    }

    .client-selector-corner select {
      padding: 10px 32px 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 14px;
      min-width: 220px;
      box-shadow: var(--shadow-soft);
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 16px;
      transition: all 0.2s ease;
    }

    .client-selector-corner select:focus {
      outline: none;
      border-color: var(--jaice-orange);
      box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1);
    }

    /* MAIN CONTENT - No sidebar, full width */
    .main-content {
      flex: 1;
      margin-top: 70px;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 70px);
      background: white;
    }

    .content {
      flex: 1;
      padding: 0 32px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    .content.initial-state {
      justify-content: flex-start;
      align-items: center;
      text-align: center;
      padding-top: calc(25vh - 70px);
    }

    .content.results-state {
      justify-content: flex-start;
      padding-top: 40px;
      text-align: left;
    }
          
    .content.results-state .hero { 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      text-align:center; 
    }
    .content.results-state .hero h1,
    .content.results-state .hero p { 
      margin-left:auto; 
      margin-right:auto; 
    }

    /* HERO SECTION */
    .hero {
      margin-bottom: 32px;
    }

    .hero h1 {
      font-size: clamp(28px, 5vw, 42px);
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--logo-grey);
      letter-spacing: -0.025em;
      line-height: 1.1;
    }

    .hero h1 .highlight {
      color: var(--jaice-orange);
    }

    .hero p {
      font-size: 18px;
      color: var(--text-muted);
      margin: 0 auto 24px;
      max-width: 600px;
      line-height: 1.5;
    }

    /* SEARCH SECTION */
    .search-section {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 8px auto;
      padding: 0 0px;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 32px;
    }

    .search-input-wrapper {
      position: relative;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
      min-height: 52px;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      z-index: 998; /* Below header (1000) and sidebar (999) */
    }

    .search-input-wrapper:focus-within {
      border-color: var(--jaice-orange);
      box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1), var(--shadow-soft);
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      background: transparent;
      color: var(--text-primary);
      padding: 8px 12px;
      resize: none;
      min-height: 20px;
      max-height: 120px;
      line-height: 1.5;
      font-family: inherit;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    /* Animated Filter Dropdown */
    .filter-dropdown {
      position: absolute;
      top: 50%; /* Start from middle of search bar */
      left: 32px; /* Match search container padding */
      right: 32px; /* Match search container padding */
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 45px 20px 20px 20px; /* Reduced top padding from 60px to 45px */
      z-index: 997; /* Below header (1000), sidebar (999), and search bar (998) */
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(-10px);
    }

    .filter-dropdown.show {
      max-height: 450px; /* Reduced from 600px since we removed additional filters */
      opacity: 1;
      transform: translateY(0);
    }

    .filter-section {
      margin-bottom: 16px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: left; /* Ensure titles are left-aligned */
    }

    .pill-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start; /* Left-align pills */
      align-items: flex-start;
    }

    .pill-btn {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .pill-btn:hover {
      background: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
    }

    .pill-btn.active {
      background: var(--jaice-orange);
      border-color: var(--jaice-orange);
      color: white;
      box-shadow: 0 2px 8px rgba(209, 72, 41, 0.3);
    }

    .pill-btn.active:hover {
      background: #C13A1F;
      border-color: #C13A1F;
      transform: translateY(-1px);
    }

    /* Search container already positioned relative at line 502 */

    .search-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--jaice-orange);
      border-radius: 8px;
      cursor: pointer;
      color: var(--white);
      transition: all 0.2s ease;
      position: relative;
    }

    .search-btn:hover:not(:disabled) {
      background: #e86900;
      transform: scale(1.05);
    }

    .search-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .search-btn:disabled .search-arrow {
      display: none;
    }

    .search-btn .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    .search-btn.loading .spinner {
      display: block;
    }

    .search-btn.loading .search-arrow {
      display: none;
    }

    .search-arrow {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .disclaimer {
      color: var(--text-muted);
      font-size: 12px;
      margin: 6px auto 0;
      font-style: italic;
      opacity: 0.8;
      text-align: center;
      max-width: 1400px;
    }

    /* RESULTS AREA */
    .results-area {
      display: none;
      animation: slideInFromBottom 0.6s ease forwards;
      margin-top: 32px;
    }

    @keyframes slideInFromBottom {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .results-area.clearing {
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }

    .answer-card {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-left: 4px solid var(--jaice-orange);
      border-radius: 16px;
      padding: 24px 60px 24px 24px;
      margin-bottom: 32px;
      position: relative;
      box-shadow: var(--shadow-soft);
      display: none;
    }

    .refresh-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .refresh-btn:hover {
      background: #fff;
      color: var(--jaice-orange);
    }

    .answer-headline {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .answer-divider {
      height: 1px;
      background: #fed7aa;
      margin: 12px 0;
    }

    .answer-details {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    /* DASHBOARD */
    .dashboard {
      margin-bottom: 32px;
    }

    .dashboard-flow {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .dashboard-item {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .dashboard-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .dashboard-item.wide-chart {
      width: 100%;
    }

    .dashboard-item.wide-chart .chart-container {
      height: 300px;
      margin: 16px 0;
    }

    .dashboard-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .dashboard-item.single {
      grid-column: span 1;
    }

    .dashboard-item h4 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--jaice-orange);
      padding-bottom: 12px;
      padding-right: 40px;
    }

    .chart-description {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.4;
      margin-bottom: 16px;
      text-align: left;
    }

    .chart-content {
      margin-top: 16px;
    }

    .bullets {
      margin: 16px 0;
      padding-left: 20px;
    }

    .bullets li {
      margin-bottom: 8px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .quote-section {
      margin: 16px 0;
    }

    .quote-item {
      margin: 12px 0;
      padding: 16px;
      background: #f8f9fa;
      border-left: 3px solid var(--jaice-orange);
      border-radius: 4px;
      font-style: italic;
      color: #666;
    }

    .quote-text {
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.5;
      font-style: italic;
    }

    .quote-speaker {
      text-align: right;
      font-size: 12px;
      color: #999;
      font-weight: 500;
      font-style: normal;
    }

    sup {
      font-size: 0.7em;
      color: var(--jaice-orange);
      font-weight: 600;
      line-height: 0;
    }

    .hidden {
      display: none !important;
    }

    .report-slides-section {
      margin-top: 32px;
    }

    .report-slides-grid {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      overflow: hidden;
      scroll-behavior: smooth;
      padding-bottom: 10px;
      position: relative;
    }

    .report-slides-container {
      position: relative;
    }

    .report-slides-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: -20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .report-slides-nav:hover {
      background: var(--jaice-orange);
      color: white;
    }

    .report-slides-nav svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .report-slide-card {
      cursor: pointer;
      flex: 0 0 calc(33.333% - 14px);
      min-width: 320px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .report-slide-preview {
      height: 220px !important;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
    }

    .report-slide-preview:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-medium);
    }

    .report-slide-content {
      padding: 0 !important;
      text-align: left;
    }

    .report-slide-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
    }

    .report-slide-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    @media (min-width: 1200px) {
      .report-slide-card {
        flex: 0 0 calc(25% - 15px);
        min-width: 340px;
      }
    }

    .report-slide-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }

    /* Prevent hover effects on the text content under images */
    .report-slide-content {
      pointer-events: none;
    }
    
    /* Re-enable pointer events for the image part */
    .report-slide-preview {
      pointer-events: auto;
    }

    /* Three-dot menu styles */
    .card-header-with-menu {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      position: relative;
    }
    
    .dropdown-container {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 10;
    }
    
    .three-dot-menu {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      opacity: 1;
      transition: opacity 0.2s ease, background-color 0.2s ease;
    }
    
    .three-dot-menu:hover {
      opacity: 1;
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .three-dot-menu .dot {
      width: 3px;
      height: 3px;
      background-color: #666;
      border-radius: 50%;
    }
    
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 160px;
      z-index: 1000;
      padding: 4px 0;
    }
    
    .dropdown-menu.show {
      display: block;
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
      background-color: #f3f4f6;
    }
    
    .dropdown-icon {
      font-size: 14px;
    }

    /* Modal styles for enlarged PDF view */
    .pdf-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .pdf-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .pdf-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .pdf-modal-image {
      width: 100%;
      height: auto;
      max-height: 85vh;
      object-fit: contain;
      display: block;
    }

    .pdf-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 10000;
    }

    .pdf-modal-close:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .pdf-modal-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      color: white;
      padding: 20px;
      font-size: 14px;
    }

    .report-slide-preview {
      aspect-ratio: 16/9;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }
    
    .slide-preview-fallback {
      width: 90%;
      height: 85%;
      background: #ffffff;
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .slide-content {
      width: 85%;
      height: 80%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .slide-header {
      width: 70%;
      height: 8px;
      background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%);
      border-radius: 2px;
    }
    
    .slide-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .slide-text-lines {
      width: 100%;
    }
    
    .slide-line {
      height: 3px;
      background: #e5e7eb;
      border-radius: 2px;
      margin: 4px 0;
    }
    
    .slide-line.short {
      width: 60%;
    }
    
    .slide-footer {
      font-size: 8px;
      color: #6b7280;
      text-align: center;
      font-weight: 500;
    }
    
    .slide-overlay {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      z-index: 2;
    }
    
    .slide-page-number {
      color: white;
    }

    .report-slide-content {
      padding: 16px;
    }

    .report-slide-title {
      font-weight: 600;
      font-size: 15px;
      line-height: 1.3;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .report-slide-subtitle {
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.2;
    }

    .no-preview {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted, #6b7280);
      font-size: 12px;
      background: rgba(0,0,0,0.02);
      border-radius: 10px;
      display: none;
    }
    
    .report-slide-preview.broken .no-preview {
      display: flex;
    }
    
    .report-slide-preview.broken img {
      display: none !important;
    }
    
    .report-slide-preview img {
      image-rendering: auto;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .main-nav {
        display: none;
      }
      
      .content {
        padding: 16px;
      }
      
      .content.initial-state {
        padding-top: calc(20vh - 70px);
      }
      
      .client-selector-corner {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 16px;
      }
      
      .dashboard-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .report-slides-grid {
        gap: 16px;
      }
      
      .report-slide-card {
        flex: 0 0 260px;
        min-width: 260px;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 0 16px;
      }
      
      .hero h1 {
        font-size: 24px;
      }
      
      .search-input-wrapper {
        min-height: 48px;
      }
      
      .dashboard-item {
        padding: 16px;
      }
      
      .answer-card {
        padding: 16px 40px 16px 16px;
      }
    }
  </style>
<link href="enhanced_chart_css.css" rel="stylesheet"/>
<link href="/modern-bridge.css" rel="stylesheet">
<script>
function monthToNum(m){
  if(!m) return 0;
  const map={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const s=String(m).toLowerCase().slice(0,3);
  return map[s]||0;
}
function sortRefsByRecency(refs){
  try{
    return (refs||[]).slice().sort((a,b)=>{
      const ya=Number(a.yearTag||a.year||0), yb=Number(b.yearTag||b.year||0);
      if(yb!==ya) return yb-ya;
      const ma=monthToNum(a.monthTag||a.month), mb=monthToNum(b.monthTag||b.month);
      return mb-ma;
    });
  }catch(e){ return refs||[]; }
}
</script>
</link><script src="/fix-showSaveMenu.js"></script>
<script src="/jaice-fixes.js"></script>
<script src="/reports-integration.js"></script>
</head>
<body>
<!-- Fixed Header with Centered Navigation -->
<header class="header">
<!-- Logo on Left -->
<div style="display: flex; align-items: center; gap: 12px;">
<a class="logo" href="/">
<img alt="Jaice" src="/assets/Slide1.JPG"/>
</a>
<span class="beta-badge">BETA</span>
</div>
<!-- Centered Navigation -->
<nav class="main-nav">
<a class="nav-link active" href="/">Home</a>
<a class="nav-link" href="/library.html">Library</a>
<a class="nav-link" href="/reports.html">Reports</a>
<a class="nav-link" href="/admin" id="adminNavLink" style="display: none;">Admin</a>
</nav>
<!-- Right Side - User Info & Profile -->
<div class="header-right">
<div class="user-info">
<span id="userDisplay">Loading...</span>
</div>
<div class="company-name" id="companyNameDisplay" style="display: none;">GENENTECH</div>
<div class="profile">
<button class="profile-btn" id="profileBtn">
<svg fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"></path>
</svg>
</button>
<div class="profile-menu" id="profileMenu">
<a href="/admin" id="adminCenterLink" style="display: none;">Admin Center</a>
<button id="logoutBtn" type="button">Sign Out</button>
</div>
</div>
</div>
</header>
<!-- Client Selector -->
<div class="client-selector-corner" id="clientSelectorCorner">
<select id="clientSelect">
<option value="">Select a client library</option>
</select>
</div>
<div class="app-layout">
<!-- ChatGPT-style Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-icon" id="sidebarIcon">
    <svg width="32" height="24" viewBox="0 0 32 24" fill="none">
      <!-- Screen outline -->
      <rect x="2" y="2" width="28" height="20" rx="3" ry="3" stroke="white" stroke-width="2" fill="none"/>
      <!-- Left sidebar portion filled white -->
      <rect x="2" y="2" width="8" height="20" rx="3" ry="3" fill="white"/>
      <!-- Separator line -->
      <line x1="10" y1="2" x2="10" y2="22" stroke="#58595B" stroke-width="1.5"/>
    </svg>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-section recent-searches">
      <h3>Recent Searches</h3>
      <div class="sidebar-section-content">
        <div id="pastSearches">
          <!-- Past searches will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="sidebar-section reports">
      <h3>Reports</h3>
      <div class="sidebar-section-content">
        <div id="recentProjects">
          <!-- Recent reports will be populated here -->
        </div>
      </div>
    </div>
  </div>
</aside>

<!-- Main Content -->
<main class="main-content">
<div class="content initial-state" id="contentArea">
<!-- Hero Section -->
<section class="hero">
<h1>ASK ABOUT YOUR RESEARCH<span class="highlight">.</span></h1>
<p>Search across your uploaded reports, questionnaires, and data.</p>
</section>
<!-- Search Section -->
<section class="search-section">
<div class="search-container">
<div class="search-input-wrapper">
<textarea class="search-input" id="searchInput" maxlength="500" placeholder="Ask a question about your research..." rows="1"></textarea>
<div class="search-controls">
<button class="filter-btn" id="filterBtn" title="Filters">
<svg fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"></path>
</svg>
</button>
<button class="search-btn" id="searchBtn">
<svg class="search-arrow" fill="currentColor" height="16" viewbox="0 0 24 24" width="16">
<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
</svg>
<div class="spinner"></div>
</button>
</div>
</div>

<!-- Animated Filter Dropdown -->
<div class="filter-dropdown" id="filterDropdown">
  <div class="filter-section">
    <h3 class="filter-title">Thinking Level</h3>
    <div class="pill-group">
      <button class="pill-btn" data-filter="thinking" data-value="detailed">Detailed</button>
      <button class="pill-btn active" data-filter="thinking" data-value="moderate">Moderate</button>
      <button class="pill-btn" data-filter="thinking" data-value="concise">Concise</button>
    </div>
  </div>
  
  <div class="filter-section">
    <h3 class="filter-title">Include Charts?</h3>
    <div class="pill-group">
      <button class="pill-btn active" data-filter="charts" data-value="yes">Yes</button>
      <button class="pill-btn" data-filter="charts" data-value="no">No</button>
    </div>
  </div>
  
  <div class="filter-section">
    <h3 class="filter-title">Quotes</h3>
    <div class="pill-group">
      <button class="pill-btn" data-filter="quotes" data-value="many">Many</button>
      <button class="pill-btn active" data-filter="quotes" data-value="moderate">Moderate</button>
      <button class="pill-btn" data-filter="quotes" data-value="none">None</button>
    </div>
  </div>
  
  <div class="filter-section">
    <h3 class="filter-title">Response Style</h3>
    <div class="pill-group">
      <button class="pill-btn active" data-filter="style" data-value="dashboard">Dashboard</button>
      <button class="pill-btn" data-filter="style" data-value="paragraph">Paragraph</button>
      <button class="pill-btn" data-filter="style" data-value="data-only">Data only</button>
    </div>
  </div>
  
  <div class="filter-section">
    <h3 class="filter-title">Years</h3>
    <div class="pill-group" id="yearsFilters">
      <!-- Dynamic year filters will be added here -->
    </div>
  </div>
  
  <div class="filter-section">
    <h3 class="filter-title">Methodologies</h3>
    <div class="pill-group" id="methodologiesFilters">
      <!-- Dynamic methodology filters will be added here -->
    </div>
  </div>
  
</div>

<div class="disclaimer">
            JAICE can make mistakes. Check important info.
          </div>
</section>
<!-- Results Area -->
<div class="results-area" id="resultsArea" style="display: none;">
<!-- Answer Card -->
<div class="answer-card" id="answerCard" style="display: none;">
<div class="card-header-with-menu">
<div class="answer-headline" id="answerHeadline"></div>
<div class="dropdown-container">
<button class="three-dot-menu" onclick="showSaveMenu(this, 'answer')" aria-label="Options">
<span class="dot"></span>
<span class="dot"></span>
<span class="dot"></span>
</button>
<div class="dropdown-menu">
<button onclick="addToReportFromDropdown('answer')" class="dropdown-item">
<span class="dropdown-icon">📄</span>
Add to Report
</button>
<button onclick="removeFromAnswer('answer')" class="dropdown-item">
<span class="dropdown-icon">🗑️</span>
Remove from Answer
</button>
</div>
</div>
</div>
<div class="answer-divider"></div>
<div class="answer-details" id="answerDetails"></div>
</div>
<!-- Dynamic Dashboard Section -->
<div class="dashboard" id="dashboard" style="display: none;">
<div class="dashboard-flow" id="dashboardFlow">
<!-- Dashboard items will be populated here with dynamic layout -->
</div>
</div>
</div>
</div>
<section class="dash-grid" id="dash-root" style="margin:24px 0;"></section>
</main>
</div>

<!-- PDF Modal -->
<div id="pdfModal" class="pdf-modal">
  <div class="pdf-modal-content">
    <button class="pdf-modal-close" id="pdfModalClose">&times;</button>
    <img id="pdfModalImage" class="pdf-modal-image" src="" alt="">
    <div class="pdf-modal-info" id="pdfModalInfo"></div>
  </div>
</div>

<!-- Scripts -->
<!-- Charts disabled: removed Chart.js and datalabels -->
<script>
    // PDF Modal functions
    function openPdfModal(fileId, page, fileName) {
      const modal = document.getElementById('pdfModal');
      const image = document.getElementById('pdfModalImage');
      const info = document.getElementById('pdfModalInfo');
      
      // Set image source and info
      image.src = `/secure-slide/${fileId}/${page}`;
      image.alt = `${fileName || 'Report'} - Slide ${page}`;
      info.innerHTML = `<strong>${fileName || 'Report'}</strong><br>Slide ${page}`;
      
      // Show modal
      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closePdfModal() {
      const modal = document.getElementById('pdfModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }

    // Initialize modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('pdfModal');
      const closeBtn = document.getElementById('pdfModalClose');
      
      // Close on X button click
      closeBtn.addEventListener('click', closePdfModal);
      
      // Close on background click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closePdfModal();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closePdfModal();
        }
      });
    });

    // Global state
    let currentUser = null;
    let currentClient = null;
    let currentReferences = [];

    // Global chart instances tracker
    window.chartInstances = window.chartInstances || new Map();

    // FIXED: Enhanced clear function that destroys all chart instances
    function clearAllCharts() {
      console.log('🧹 Clearing all chart instances...');
      
      if (window.chartInstances) {
        window.chartInstances.forEach((chart, containerId) => {
          try {
            chart.destroy();
            console.log('Destroyed chart:', containerId);
          } catch (e) {
            console.warn('Error destroying chart:', containerId, e);
          }
        });
        window.chartInstances.clear();
      }
      
      // Also remove any remaining canvas elements
      document.querySelectorAll('canvas[id$="_canvas"]').forEach(function(canvas) {
        try {
          canvas.remove();
        } catch (e) {
          console.warn('Error removing canvas:', e);
        }
      });
      
      console.log('✅ All charts cleared');
    }

    // Helper function to remove existing sections
    function removeExistingSections() {
      const existingSlides = document.getElementById('reportSlides');
      const existingReports = document.getElementById('reportsReferenced');
      
      if (existingSlides) {
        existingSlides.querySelectorAll('[id^="chart-"]').forEach(chartContainer => {
          const chartId = chartContainer.id;
          if (window.chartInstances && window.chartInstances.has(chartId)) {
            try {
              window.chartInstances.get(chartId).destroy();
              window.chartInstances.delete(chartId);
            } catch (e) {
              console.warn('Error destroying chart in slides section:', e);
            }
          }
        });
        existingSlides.remove();
      }
      
      if (existingReports) {
        existingReports.remove();
      }
    }

    // Chart rendering disabled - no-op stub to prevent errors
    function renderChart(containerId, chartData) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
    }

    // Helper functions
    function formatRefsToSup(text) {
      const s = String(text || "");
      return s
        .replace(/\s?\[(\d+(?:\s*,\s*\d+)*)\]/g, (_, m) => `<sup>${m.replace(/\s+/g, '')}</sup>`)
        .replace(/\((\d+(?:\s*,\s*\d+)*)\)/g, (_, m) => `<sup>${m.replace(/\s+/g, '')}</sup>`)
        .replace(/\[ref(\d+)\]/gi, '<sup>$1</sup>');
    }

    function switchToResultsLayout() {
      const contentArea = document.getElementById('contentArea');
      contentArea.classList.remove('initial-state');
      contentArea.classList.add('results-state');
      
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Hardened init: sends cookies, robust /me handling, admin-only gate on /admin
    async function initializeApp() {
      try {
        const response = await fetch('/me', {
          credentials: 'include',           // ensure session cookie is sent
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });

        if (response.status === 401) {
          window.location.href = '/login.html';
          return;
        }
        if (!response.ok) {
          console.error('Init /me failed', response.status, await response.text().catch(()=>'')); 
          window.location.href = '/login.html';
          return;
        }

        const payload = await response.json();
        const user = payload && payload.user ? payload.user : null;
        const activeClientId = payload && 'activeClientId' in payload ? payload.activeClientId : null;

        if (!user || !user.role) {
          console.error('Malformed /me payload:', payload);
          window.location.href = '/login.html';
          return;
        }

        // Admin-only guard when on the admin page
        const onAdminPage = location.pathname.startsWith('/admin') || document.body.dataset.page === 'admin';
        if (onAdminPage) {
          const role = String(user.role).toLowerCase().trim();
          if (role !== 'admin') {
            window.location.href = '/';
            return;
          }
        }

        // set globals
        currentUser = user;
        currentClient = activeClientId || null;

        // init UI
        if (typeof updateUserDisplay === 'function') updateUserDisplay();
        if (typeof loadClientLibraries === 'function') await loadClientLibraries();
        if (typeof setupEventListeners === 'function') setupEventListeners();

      } catch (error) {
        console.error('Failed to initialize app:', error);
        window.location.href = '/login.html';
      }
    }

    function updateUserDisplay() {
      const userDisplay = document.getElementById('userDisplay');
      const companyNameDisplay = document.getElementById('companyNameDisplay');
      const adminCenterLink = document.getElementById('adminCenterLink');
      const adminNavLink = document.getElementById('adminNavLink');
      const clientSelectorCorner = document.getElementById('clientSelectorCorner');
      
      if (currentUser) {
        const roleDisplay = currentUser.role === 'admin' ? 'admin' : currentUser.role;
        userDisplay.textContent = `${currentUser.username} (${roleDisplay})`;
        
        if (currentUser.role === 'admin') {
          if (adminCenterLink) adminCenterLink.style.display = 'block';
          if (adminNavLink) adminNavLink.style.display = 'block';
          if (clientSelectorCorner) clientSelectorCorner.classList.add('show');
          if (companyNameDisplay) companyNameDisplay.style.display = 'none';
        } else {
          if (companyNameDisplay) {
            companyNameDisplay.style.display = 'block';
            companyNameDisplay.textContent = 'GENENTECH';
          }
          if (clientSelectorCorner) clientSelectorCorner.classList.remove('show');
          if (adminCenterLink) adminCenterLink.style.display = 'none';
          if (adminNavLink) adminNavLink.style.display = 'none';
        }
      }
    }

    async function loadClientLibraries() {
      try {
        const response = await fetch('/api/client-libraries');
        if (response.ok) {
          const libraries = await response.json();
          
          const clientSelect = document.getElementById('clientSelect');
          clientSelect.innerHTML = '<option value="">Select a client library</option>';
          
          libraries.forEach(function(lib) {
            const option = document.createElement('option');
            option.value = lib.id;
            option.textContent = lib.name;
            clientSelect.appendChild(option);
          });
          
          if (currentClient) {
            clientSelect.value = currentClient;
          }
        }
      } catch (error) {
        console.warn('Failed to load client libraries:', error);
      }
    }

    function setupEventListeners() {
      // Profile menu
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');
      
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileMenu.classList.toggle('show');
      });
      
      document.addEventListener('click', () => {
        profileMenu.classList.remove('show');
      });

      // Search functionality
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      
      searchBtn.addEventListener('click', performSearch);
      
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          performSearch();
        }
      });

      const clientSelect = document.getElementById('clientSelect');
      clientSelect.addEventListener('change', async (e) => {
        const selectedClientId = e.target.value;
        if (selectedClientId) {
          currentClient = selectedClientId;
        }
      });

      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch('/auth/logout', { method: 'POST' });
          window.location.href = '/login.html';
        } catch (error) {
          window.location.href = '/login.html';
        }
      });
    }

    async function performSearch(refresh = false) {
      const query = document.getElementById('searchInput').value.trim();
      
      if (!query) {
        return;
      }

      if (currentUser?.role === 'admin' && !currentClient) {
        alert('Please select a client library first');
        return;
      }

      if (!refresh) {
        clearPreviousResults();
      }

      const searchBtn = document.getElementById('searchBtn');
      searchBtn.disabled = true;
      searchBtn.classList.add('loading');

      try {
        // Collect filter values from the dropdown state if available
        const dd = document.getElementById('filterDropdown');
        const getActiveVal = (name)=>{ const b=dd && dd.querySelector(`.pill-btn[data-filter="${name}"].active`); return b?b.dataset.value:null; };
        const thinking = getActiveVal('thinking') || 'moderate';
        const charts = getActiveVal('charts') || 'yes';
        const quotes = getActiveVal('quotes') || 'moderate';
        const style = getActiveVal('style') || 'dashboard';
        const yearsSel = Array.from(dd?.querySelectorAll('.pill-btn[data-filter="years"].active')||[]).map(b=>b.dataset.value);
        const methSel = Array.from(dd?.querySelectorAll('.pill-btn[data-filter="methodologies"].active')||[]).map(b=>b.dataset.value);

        // Map thinking to topk
        const topk = (thinking==='detailed') ? 50 : (thinking==='concise') ? 10 : 30;

        const requestBody = {
          userQuery: query,
          generateSupport: true,
          filters: {
            thinking, charts, quotes, style,
            years: yearsSel,
            methodologies: methSel,
            topk
          }
        };
        
        // Add client library restriction for client users
        if (currentUser?.role === 'client') {
          const clientLibrary = currentUser.library || currentUser.libraryId || currentUser.clientLibrary;
          if (clientLibrary) {
            requestBody.libraryFilter = clientLibrary;
            requestBody.restrictToLibrary = clientLibrary;
          }
        }

        if (currentUser?.role === 'admin' && currentClient) {
          requestBody.clientId = currentClient;
        }

        if (refresh) {
          requestBody.refresh = Date.now();
        }

        const response = await fetch('/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Search failed');
        }

        const results = await response.json();
        
        window.lastSearchResponse = results; // Store for report slides access
        switchToResultsLayout();
        displayResults(results);

      } catch (error) {
        console.error('Search failed:', error);
        alert(error.message || 'Search failed. Please try again.');
      } finally {
        searchBtn.disabled = false;
        searchBtn.classList.remove('loading');
      }
    }

    function determineLayoutClass(theme, index) {
      const hasChart = theme.chartData && theme.chartData.series && theme.chartData.series.length > 0;
      
      if (!hasChart) {
        return 'single';
      }
      
      const chartType = theme.chartData.type;
      const dataPointCount = theme.chartData.series.length;
      
      const needsFullWidth = (
        (chartType === 'bar' && dataPointCount >= 5) ||
        (chartType === 'line') ||
        (index === 0 && chartType === 'bar')
      );
      
      return needsFullWidth ? 'wide-chart' : 'single';
    }

    function createDashboardItem(theme, layoutClass = '', index = 0) {
      console.log('🎨 HTML: Creating dashboard item:', theme.title);
      
      const item = document.createElement('div');
      item.className = `dashboard-item response-card ${layoutClass}`;
      
      // Clean styling for cards
      item.style.position = 'relative';
      
      const bullets = Array.isArray(theme.bullets) ? 
        Array.from(new Set(theme.bullets)).map(function(b) { return '<li>' + formatRefsToSup(b) + '</li>'; }).join('') : '';
      
      const normalizedQuotes = (Array.isArray(theme.quotes) ? theme.quotes : [])
        .map(function(q){
          const rawText = ((q && (q.text || q)) || '').toString().trim();
          let speaker = ((q && q.speaker) || '').toString().trim();
          // Accept pre-quoted text or extract a quoted segment within the string
          let quotedText = '';
          if (/^\s*["“].+["”"]\s*$/.test(rawText)) {
            quotedText = rawText;
          } else {
            const m = rawText.match(/["“']([^"”']{3,})["”']/);
            if (m) quotedText = '“' + m[1] + '”';
          }
          // Try to parse speaker from trailing em dash if not provided
          if (!speaker) {
            const sm = rawText.match(/—\s*([^—]{2,80})$/);
            if (sm) speaker = sm[1].trim();
          }
          const allowed = /(HCP|Patient|Caregiver|Respondent|Physician|Doctor|MD|DO|NP|Nurse|KOL|Specialist|Participant|Interviewee)/i;
          if (quotedText && speaker && allowed.test(speaker)) {
            return { text: quotedText, speaker };
          }
          return null;
        })
        .filter(Boolean)
        .slice(0, 2);
      
      const quotes = normalizedQuotes.map(function(q){
        return '<div class="quote-item">' +
          '<div class="quote-text">' + formatRefsToSup(q.text) + '</div>' +
          '<div class="quote-speaker">— ' + q.speaker + '</div>' +
        '</div>';
      }).join('');

      let chartHtml = '';
      if (theme.chartData && Array.isArray(theme.chartData.series) && theme.chartData.series.length > 0) {
        const chartId = 'chart-' + Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
        const containerClass = layoutClass === 'wide-chart' ? 'chart-container' : '';
        const chartHeight = layoutClass === 'wide-chart' ? '300px' : '220px';
        
        const chartTitle = theme.chartData.title || theme.title;
        
        chartHtml = 
          '<div class="chart-wrapper ' + containerClass + '" style="margin: 16px 0; background: #f8f9fa; border-radius: 8px; padding: 16px; height: ' + chartHeight + ';">' +
            '<h5 style="margin: 0 0 12px 0; color: #333; font-size: 14px; font-weight: 600; text-align: center;">' + chartTitle + '</h5>' +
            '<div id="' + chartId + '" style="position: relative; height: calc(100% - 32px); min-height: 160px;"></div>' +
          '</div>';
        
        setTimeout(() => {
          try {
            renderChart(chartId, theme.chartData);
          } catch (error) {
            console.error('Chart rendering failed:', error);
            const container = document.getElementById(chartId);
            if (container) {
              container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Chart temporarily unavailable</p>';
            }
          }
        }, 200 + (index * 50));
      }
      
      // CREATE HTML WITH 3-DOT MENU
      const htmlContent = 
        '<div class="card-header-with-menu" style="position: relative; display: flex; justify-content: space-between; align-items: flex-start;">' +
          '<h4 style="margin: 0; flex: 1;">' + (theme.title || 'Supporting Finding') + '</h4>' +
          '<div class="dropdown-container" style="position: absolute; top: 0; right: 0; z-index: 10;">' +
            '<button class="three-dot-menu" onclick="showSaveMenu(this, \'theme\')" aria-label="Options" style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 2px; opacity: 1; transition: opacity 0.2s ease, background-color 0.2s ease;">' +
              '<span class="dot" style="width: 3px; height: 3px; background-color: #666; border-radius: 50%;"></span>' +
              '<span class="dot" style="width: 3px; height: 3px; background-color: #666; border-radius: 50%;"></span>' +
              '<span class="dot" style="width: 3px; height: 3px; background-color: #666; border-radius: 50%;"></span>' +
            '</button>' +
            '<div class="dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 160px; z-index: 1000; padding: 4px 0;">' +
              '<button onclick="addToReportFromDropdown(\'theme\')" class="dropdown-item" style="display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: white; cursor: pointer; font-size: 14px; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">' +
                '<span class="dropdown-icon" style="margin-right: 8px;">📄</span>Add to Report' +
              '</button>' +
              '<button onclick="removeFromAnswer(\'theme\')" class="dropdown-item" style="display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: white; cursor: pointer; font-size: 14px; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">' +
                '<span class="dropdown-icon" style="margin-right: 8px;">🗑️</span>Remove from Answer' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
        (theme.subtitle ? '<p class="chart-description">' + theme.subtitle + '</p>' : '') +
        '<div class="chart-content">' +
          chartHtml +
          (bullets ? '<ul class="bullets">' + bullets + '</ul>' : '') +
          (quotes ? '<div class="quote-section">' + quotes + '</div>' : '') +
        '</div>';
      
      console.log('🎨 HTML: Setting innerHTML for:', theme.title);
      item.innerHTML = htmlContent;
      
      // Verify the menu was created
      setTimeout(() => {
        const menu = item.querySelector('.three-dot-menu');
        const container = item.querySelector('.dropdown-container');
        console.log('🎨 HTML: Verification for', theme.title + ':');
        console.log('  - Menu element found:', !!menu);
        console.log('  - Container found:', !!container);
      }, 100);
      
      console.log('🎨 HTML: Dashboard item completed for:', theme.title);
      return item;
    }

    // Enhanced displayReportSlides function with content page resolution
    async function resolveToContentPage(fileId, page) {
      const searchRange = [page, page + 1, page - 1, page + 2, page - 2, page + 3, page - 3];
      const dividerPattern = /(detailed findings|executive summary|appendix|agenda|section|table of contents|contents|toc|overview|methodology|disclaimer|thank you|cover|divider|q\s*&\s*a|q&a)/i;
      
      for (const p of searchRange) {
        if (p <= 1) continue;
        
        try {
          const response = await fetch(`/secure-slide/text/${fileId}/${p}`);
          if (!response.ok) continue;
          
          const data = await response.json();
          if (!data.ok) continue;
          
          // Content must have digits or % and not match divider keywords
          const hasNumbers = data.hasDigits || data.hasPercent;
          const isDivider = dividerPattern.test(data.snippet || '');
          
          if (hasNumbers && !isDivider) {
            return p;
          }
        } catch (e) {
          console.warn(`Failed to check page ${p} for ${fileId}:`, e);
          continue;
        }
      }
      
      // If no content page found, skip this slide entirely
      return null;
    }

    function displayReportSlides() {
      // Do not render slides in paragraph style
      const dd = document.getElementById('filterDropdown');
      const styleBtn = dd && dd.querySelector('.pill-btn[data-filter="style"].active');
      const responseStyle = styleBtn ? styleBtn.dataset.value : 'dashboard';
      if (responseStyle === 'paragraph') return;

      const dashboard = document.getElementById('dashboard');

      // Remove previous section if present
      const prev = document.getElementById('reportSlides');
      if (prev) prev.remove();

      const section = document.createElement('div');
      section.id = 'reportSlides';
      section.className = 'report-slides-section';
      section.innerHTML = `
        <h3 style="margin-bottom:16px;color:var(--text-primary);font-size:18px;font-weight:600;">Related Report Slides</h3>
        <div class="report-slides-container">
          <button class="report-slides-nav report-slides-prev" id="reportSlidesPrev" style="display: none; left: -20px;">
            <svg viewBox="0 0 24 24">
              <path d="M14.71 6.71c-.39-.39-1.02-.39-1.41 0L8.71 11.3c-.39.39-.39 1.02 0 1.41l4.59 4.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L10.83 12l3.88-3.88c.39-.39.39-1.02 0-1.41z"/>
            </svg>
          </button>
          <div class="report-slides-grid" id="reportSlidesGrid"></div>
          <button class="report-slides-nav report-slides-next" id="reportSlidesNext" style="display: none;">
            <svg viewBox="0 0 24 24">
              <path d="M9.29 6.71c-.39.39-.39 1.02 0 1.41L13.17 12l-3.88 3.88c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l4.59-4.59c.39-.39.39-1.02 0-1.41L10.7 6.7c-.38-.38-1.02-.38-1.41.01z"/>
            </svg>
          </button>
        </div>
      `;
      dashboard.after(section);

      // Get citations from current references or search response
      const citations = window.currentReferences || 
        (window.lastSearchResponse && window.lastSearchResponse.references && window.lastSearchResponse.references.chunks) || 
        [];

      if (!citations || citations.length === 0) {
        const grid = document.getElementById('reportSlidesGrid');
        grid.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">No report slides available for this search.</p>';
        return;
      }

      // Extract fileId and page from citations
      const slidePromises = citations.slice(0, 12).map(async (citation) => {
        const fileId = citation.fileId || citation.driveId || citation.gdocId;
        const page = citation.page || citation.pageNumber || citation.pageIndex || 1;
        
        if (!fileId) return null;
        
        // Resolve to nearest content page
        const contentPage = await resolveToContentPage(fileId, page);
        if (!contentPage) return null;
        
        return {
          fileId: fileId,
          page: contentPage,
          source: citation.fileName || citation.source || 'Unknown Report',
          date: (citation.monthTag ? (citation.monthTag + ' ') : '') + (citation.yearTag || 'Unknown Date')
        };
      });

      // Wait for all slide resolutions
      Promise.all(slidePromises).then(resolvedSlides => {
        const validSlides = resolvedSlides.filter(Boolean);

        // De-duplicate by fileId + page combination
        const seen = new Set();
        const uniqueSlides = validSlides.filter(slide => {
          const key = `${slide.fileId}-${slide.page}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        }).slice(0, 6);

        const grid = document.getElementById('reportSlidesGrid');
        const nextBtn = document.getElementById('reportSlidesNext');
        
        if (!uniqueSlides.length) {
          grid.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">No content slides found for this search.</p>';
          nextBtn.style.display = 'none';
          return;
        }

        const prevBtn = document.getElementById('reportSlidesPrev');
        
        // Show/hide navigation buttons based on slide count
        if (uniqueSlides.length > 3) {
          let currentIndex = 0;
          const maxIndex = Math.max(0, uniqueSlides.length - 3);
          
          function updateButtons() {
            prevBtn.style.display = currentIndex > 0 ? 'flex' : 'none';
            nextBtn.style.display = currentIndex < maxIndex ? 'flex' : 'none';
          }
          
          nextBtn.addEventListener('click', () => {
            if (currentIndex < maxIndex) {
              currentIndex++;
              const scrollAmount = currentIndex * (340 + 20); // card width + gap
              grid.scrollTo({ left: scrollAmount, behavior: 'smooth' });
              updateButtons();
            }
          });
          
          prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
              currentIndex--;
              const scrollAmount = currentIndex * (340 + 20); // card width + gap
              grid.scrollTo({ left: scrollAmount, behavior: 'smooth' });
              updateButtons();
            }
          });
          
          updateButtons(); // Initial button state
        } else {
          nextBtn.style.display = 'none';
          prevBtn.style.display = 'none';
        }

        const stripExt = (s) => String(s||'').replace(/\.[^/.]+$/,'');

        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const card = entry.target;
            const img = card.querySelector('img.slide-img');
            const loader = card.querySelector('.slide-loading');
            const frame = card.querySelector('.report-slide-preview');
            if (img && img.dataset.src && !img.src) {
              loader.style.display = 'flex';
              img.src = img.dataset.src;
              img.onload = () => { img.style.display='block'; loader.style.display='none'; };
              img.onerror = () => { loader.style.display='none'; frame.classList.add('broken'); };
            }
            io.unobserve(card);
          });
        }, { rootMargin: '200px 0px' });

        uniqueSlides.forEach((slide) => {
          const safeTitle = stripExt(slide.source || 'Unknown Report');
          const safeDate = slide.date || 'Unknown Date';
          
          // Use resolved content page number
          const imgSrc = `/secure-slide/${encodeURIComponent(slide.fileId)}/${slide.page}`;

          const card = document.createElement('div');
          card.className = 'report-slide-card';

          card.innerHTML = `
            <div class="report-slide-preview" style="position:relative;">
              <div class="slide-loading" aria-hidden="true"><div class="spinner"></div></div>
              <div class="no-preview">No preview</div>
              <img class="slide-img" data-src="${imgSrc}" alt="Slide ${slide.page}" style="width:100%;height:100%;object-fit:cover;display:none;" />
            </div>
            <div class="report-slide-content">
              <div class="report-slide-title">${safeTitle}</div>
              <div class="report-slide-subtitle">
                ${safeDate} • Slide ${slide.page}
              </div>
            </div>
          `;

          // Add click handler for modal popup
          card.addEventListener('click', () => {
            const cleanFileName = (slide.fileName || slide.source || 'Report').replace(/\.[^/.]+$/, '');
            openPdfModal(slide.fileId, slide.page, cleanFileName);
          });

          grid.appendChild(card);
          io.observe(card);
        });

        try { console.log(`✅ Display complete - ${uniqueSlides.length} content slides rendered`); } catch {}
      });
    }

    function displayReportsReferenced(references) {
      const reportSlidesSection = document.getElementById('reportSlides');
      
      const reportsSection = document.createElement('div');
      reportsSection.id = 'reportsReferenced';
      reportsSection.style.cssText = `
        margin-top: 40px;
        border-top: 2px solid var(--border);
        padding-top: 24px;
      `;
      
      reportsSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 12px 0; user-select: none;" onclick="toggleReportsReferenced()">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">Reports Referenced</h3>
          <span style="font-size: 16px; color: var(--text-muted);">▼</span>
        </div>
        <div id="reportsReferencedContent" style="max-height: 500px; overflow-y: auto; margin-top: 16px;">
          <!-- Report references will be populated here -->
        </div>
      `;
      
      reportSlidesSection.after(reportsSection);
      
      const content = document.getElementById('reportsReferencedContent');
      
      if (!references || !references.length) {
        content.innerHTML = '<p style="color: var(--text-muted);">No references found for this search.</p>';
        return;
      }

      // Filter and deduplicate references to show only current, valid files
      const validReferences = references
        .filter(function(ref) { return ref && ref.fileName && ref.fileId; }) // Only refs with valid file data
        .reduce(function(unique, ref) {
          // Deduplicate by fileName only (not fileName + page)
          const fileName = ref.fileName;
          if (!unique.some(function(existing) { 
            return existing.fileName === fileName; 
          })) {
            unique.push(ref);
          }
          return unique;
        }, [])
        .slice(0, 10); // Limit to 10 references

      if (validReferences.length === 0) {
        content.innerHTML = '<p style="color: var(--text-muted);">No valid references found for this search.</p>';
        return;
      }

      // Create a global report numbering map to ensure consistent numbering
      if (!window.reportNumberMap) {
        window.reportNumberMap = new Map();
      }

      validReferences.forEach(function(ref, index) {
        // Get or assign a consistent number for this report
        let reportNumber;
        if (window.reportNumberMap.has(ref.fileName)) {
          reportNumber = window.reportNumberMap.get(ref.fileName);
        } else {
          reportNumber = window.reportNumberMap.size + 1;
          window.reportNumberMap.set(ref.fileName, reportNumber);
        }
        const refDiv = document.createElement('div');
        refDiv.style.cssText = `
          background: var(--white);
          border: 1px solid var(--border);
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 12px;
          display: flex;
          align-items: flex-start;
          gap: 12px;
        `;
        
        const pageDisplay = (ref.page && ref.page > 1) || (ref.pageNumber && ref.pageNumber > 1) 
          ? '<span><strong>Page:</strong> ' + (ref.page || ref.pageNumber) + '</span>' 
          : '';
        
        refDiv.innerHTML = 
          '<div style="background: var(--jaice-orange); color: white; font-size: 12px; font-weight: 700; padding: 6px 10px; border-radius: 50%; min-width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">' +
            reportNumber +
          '</div>' +
          '<div style="flex: 1;">' +
            '<div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">' +
              (ref.fileName || ref.title || 'Reference Document').replace(/\.[^/.]+$/, '') +
            '</div>' +
            '<div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: var(--text-muted);">' +
              '<span><strong>Year:</strong> ' + (ref.yearTag || '') + '</span>' +
              '<span><strong>Month:</strong> ' + (ref.monthTag || '') + '</span>' +
              '<span><strong>Methodology:</strong> ' + (ref.methodologies && ref.methodologies.length ? ref.methodologies.join(', ') : (ref.reportTag || '')) + '</span>' +
              (ref.fieldwork ? '<span><strong>Fieldwork:</strong> ' + ref.fieldwork + '</span>' : '') +
              (ref.sample ? '<span><strong>Sample:</strong> ' + ref.sample + '</span>' : '') +
            '</div>' +
            '</div>' +
          '</div>';
        
        content.appendChild(refDiv);
      });
    }

    function toggleReportsReferenced() {
      const content = document.getElementById('reportsReferencedContent');
      const toggle = document.querySelector('#reportsReferenced span');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '▼';
      } else {
        content.style.display = 'none'; 
        toggle.textContent = '▶';
      }
    }

    function parseStructuredAnswer(answer) {
      const text = String(answer || '').trim();
      
      const headlineMatch = text.match(/HEADLINE:\s*(.+?)(?=\nDETAILS:|$)/s);
      const detailsMatch = text.match(/DETAILS:\s*(.+?)$/s);
      
      if (headlineMatch && detailsMatch) {
        return {
          headline: headlineMatch[1].trim(),
          details: detailsMatch[1].trim()
        };
      }
      
      const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
      const headline = sentences[0] || 'Key findings from your research library';
      const details = sentences.slice(1).join(' ').trim();
      
      return { headline, details };
    }

    function clearPreviousResults() {
      const resultsArea = document.getElementById('resultsArea');
      if (resultsArea) {
        resultsArea.classList.add('clearing');
        
        setTimeout(() => {
          const answerCard = document.getElementById('answerCard');
          const dashboard = document.getElementById('dashboard');
          const dashboardFlow = document.getElementById('dashboardFlow');
          
          if (answerCard) answerCard.style.display = 'none';
          if (dashboard) dashboard.style.display = 'none';
          if (dashboardFlow) dashboardFlow.innerHTML = '';
          
          removeExistingSections();
          
          resultsArea.classList.remove('clearing');
        }, 300);
      }
    }

    // Enhanced displayResults function to ensure proper data handling
    function displayResults(results) {
      const resultsArea = document.getElementById('resultsArea');
      const answerCard = document.getElementById('answerCard');
      const answerHeadline = document.getElementById('answerHeadline');
      const answerDetails = document.getElementById('answerDetails');
      const dashboard = document.getElementById('dashboard');

      resultsArea.style.display = 'block';

      // Store the complete response for thumbnail access
      window.lastSearchResponse = results;
      
      console.log('Debug - Full search results:', results);
      console.log('Debug - Reports in results:', results.reports);

      // Set references for backward compatibility
      currentReferences = [];
      if (results.references) {
        if (Array.isArray(results.references)) {
          currentReferences = results.references;
        } else if (results.references.chunks && Array.isArray(results.references.chunks)) {
          currentReferences = results.references.chunks;
        }
      }
      
      // CRITICAL: Use the reports array which contains thumbnails and correct filenames
      if (results.reports && Array.isArray(results.reports)) {
        console.log('✅ Using reports data with thumbnails and correct filenames');
        console.log('Debug - Reports data:', results.reports);
        
        // Use reports for display purposes (they have thumbnails)
        // but keep references for other functionality
        window.reportsWithThumbnails = results.reports;
      }

      // Determine response style from current filter dropdown
      const dd = document.getElementById('filterDropdown');
      const styleBtn = dd && dd.querySelector('.pill-btn[data-filter="style"].active');
      const responseStyle = styleBtn ? styleBtn.dataset.value : 'dashboard';

      // If paragraph style: render a single white box, no dashboard grid
      if (responseStyle === 'paragraph') {
        const content = (results && results.answer) ? results.answer.trim() : '';
        const container = document.getElementById('dashboardFlow');
        if (container) {
          container.innerHTML = '';
          const card = document.createElement('div');
          card.className = 'dashboard-item';
          card.style.padding = '20px';
          card.style.border = '1px solid var(--border)';
          card.style.borderRadius = '12px';
          card.style.background = '#fff';
          // Render raw AI content: allow headings, bullets, and paragraphs
          card.innerHTML = `<div style="font-size:15px;line-height:1.7;color:var(--text-primary);white-space:pre-wrap;">${formatRefsToSup(content)}</div>`;
          container.appendChild(card);
        }
        // Show results area and hide the default answer card
        answerCard.style.display = 'none';
        dashboard.style.display = 'block';
        // Skip building theme cards in paragraph mode
        return;
      }

      // Default: show the structured answer card
      if (results.answer && results.answer.trim()) {
        const formattedAnswer = parseStructuredAnswer(results.answer);
        answerHeadline.innerHTML = formatRefsToSup(formattedAnswer.headline);
        answerDetails.innerHTML = formatRefsToSup(formattedAnswer.details);
        answerCard.style.display = 'block';
      } else {
        answerCard.style.display = 'none';
      }

      // Display dashboard themes
      const dashboardFlow = document.getElementById('dashboardFlow');
      console.log('🚨 DEBUG: dashboardFlow element found:', !!dashboardFlow);
      
      if (!dashboardFlow) {
        console.error('🚨 ERROR: dashboardFlow element not found!');
        return;
      }
      
      dashboardFlow.innerHTML = '';
      
      const themes = Array.isArray(results.supportingThemes) ? results.supportingThemes : [];
      console.log('🚨 DEBUG: Themes received:', themes.length, themes);

      if (themes.length) {
        // FIXED: Show ALL themes - don't filter by title duplication
        console.log('🎯 DISPLAYING all', themes.length, 'themes received from server');
        
        themes.forEach(function(theme, index) {
          console.log('🎯 Processing theme', index + 1, ':', theme.title);
          
          const layoutClass = determineLayoutClass(theme, index);
          console.log('🎯 Layout class determined:', layoutClass);
          
          const item = createDashboardItem(theme, layoutClass, index);
          console.log('🎯 Dashboard item created:', !!item);
          
          if (layoutClass === 'wide-chart') {
            console.log('🎯 Adding wide chart to dashboardFlow');
            dashboardFlow.appendChild(item);
          } else {
            const lastChild = dashboardFlow.lastElementChild;
            if (!lastChild || !lastChild.classList.contains('dashboard-row') || lastChild.children.length >= 2) {
              console.log('🎯 Creating new row for item');
              const rowDiv = document.createElement('div');
              rowDiv.className = 'dashboard-row';
              rowDiv.appendChild(item);
              dashboardFlow.appendChild(rowDiv);
            } else {
              console.log('🎯 Adding to existing row');
              lastChild.appendChild(item);
            }
          }
          
          console.log('🎯 Theme', index + 1, 'added to DOM');
        });
      } else {
        console.log('🚨 No themes to display');
      }

      dashboard.style.display = 'block';
      
      // Clean up any existing sections before displaying new ones
      removeExistingSections();
      
      // Display report slides with thumbnails
      displayReportSlides();
      
      // Display references section
      displayReportsReferenced(currentReferences);
    }

    // Make functions globally accessible
    window.toggleReportsReferenced = toggleReportsReferenced;
    window.renderChart = renderChart;
    window.clearAllCharts = clearAllCharts;

    window.addEventListener('beforeunload', () => {
      clearAllCharts();
    });

    // Sidebar functionality
    function initializeSidebar() {
      // Clean up any conflicting sidebar elements from other scripts
      const oldSidebar = document.getElementById('enhancedSidebar');
      const oldHamburger = document.getElementById('hamburgerBtn');
      const oldRevealZone = document.getElementById('sidebarRevealZone');
      
      if (oldSidebar) oldSidebar.remove();
      if (oldHamburger) oldHamburger.remove();
      if (oldRevealZone) oldRevealZone.remove();
      
      const sidebar = document.getElementById('sidebar');
      const sidebarIcon = document.getElementById('sidebarIcon');
      const mainContent = document.querySelector('.main-content');
      
      let isPinned = localStorage.getItem('sidebarPinned') === 'true';
      
      if (!sidebar || !sidebarIcon || !mainContent) {
        console.warn('Sidebar elements not found', { sidebar, sidebarIcon, mainContent });
        return;
      }

      // Set initial pinned state
      if (isPinned) {
        sidebar.classList.add('pinned');
        sidebar.style.transform = 'translateX(0)'; // Force transform
        mainContent.style.marginLeft = '260px';
      } else {
        sidebar.style.transform = 'translateX(-220px)'; // Initial state showing 40px edge
      }
      
      // Function to toggle sidebar
      function toggleSidebar(e) {
        e.stopPropagation();
        console.log('Sidebar icon clicked, isPinned:', isPinned);
        isPinned = !isPinned;
        localStorage.setItem('sidebarPinned', isPinned);
        
        if (isPinned) {
          sidebar.classList.add('pinned');
          sidebar.style.transform = 'translateX(0)';
          mainContent.style.marginLeft = '260px';
          console.log('Sidebar pinned');
        } else {
          sidebar.classList.remove('pinned');
          sidebar.style.transform = 'translateX(-220px)';
          mainContent.style.marginLeft = '40px';
          console.log('Sidebar unpinned');
        }
      }

      // Toggle sidebar on icon click
      sidebarIcon.addEventListener('click', toggleSidebar);

      // Add hover listeners to the sidebar for better hover detection
      sidebar.addEventListener('mouseenter', () => {
        console.log('Sidebar mouse enter, isPinned:', isPinned);
        if (!isPinned) {
          sidebar.style.transform = 'translateX(0)';
        }
      });

      sidebar.addEventListener('mouseleave', () => {
        console.log('Sidebar mouse leave, isPinned:', isPinned);
        if (!isPinned) {
          sidebar.style.transform = 'translateX(-220px)';
        }
      });
    }

    // Load and display past searches with scroll prevention
    function loadPastSearches() {
      const container = document.getElementById('pastSearches');
      const searches = JSON.parse(localStorage.getItem('pastSearches') || '[]');
      
      if (searches.length === 0) {
        container.innerHTML = '<div class="sidebar-item" style="opacity: 0.6; cursor: default;">No recent searches</div>';
        return;
      }
      
      // Calculate maximum items that fit without scrolling
      const maxItems = calculateMaxItemsWithoutScroll('pastSearches');
      const displaySearches = searches.slice(0, maxItems);
      
      // Clean up excess data if we're limiting display
      if (searches.length > maxItems) {
        const cleanedSearches = searches.slice(0, maxItems);
        localStorage.setItem('pastSearches', JSON.stringify(cleanedSearches));
      }
      
      container.innerHTML = '';
      displaySearches.forEach((search, index) => {
        const item = document.createElement('div');
        item.className = 'sidebar-item';
        item.innerHTML = `
          <div class="sidebar-item-text">${search.query}</div>
          <div class="sidebar-item-subtitle">${formatDate(search.date)}</div>
        `;
        item.addEventListener('click', () => {
          restoreSearchResults(search);
        });
        container.appendChild(item);
      });
    }

    // Restore exact search results instead of re-searching
    function restoreSearchResults(search) {
      const contentArea = document.getElementById('contentArea');
      const searchInput = document.getElementById('searchInput');
      
      if (searchInput) {
        searchInput.value = search.query;
      }
      
      if (contentArea && search.results && search.results.html) {
        // Restore the exact HTML content and state
        contentArea.innerHTML = search.results.html;
        contentArea.className = search.results.className || `content ${search.results.state || 'completed'}`;
        
        // Restore body state if available
        if (search.results.bodyState) {
          document.body.className = search.results.bodyState;
        }
        
        // Re-initialize all interactive elements
        setTimeout(() => {
          // Re-initialize charts
          if (typeof initializeAllCharts === 'function') {
            initializeAllCharts();
          }
          
          // Re-initialize enhanced charts
          if (typeof initializeEnhancedCharts === 'function') {
            initializeEnhancedCharts();
          }
          
          // Re-attach study details and card menus
          if (typeof attachStudyDetails === 'function') {
            const reportsContent = document.getElementById('reportsReferencedContent');
            if (reportsContent) {
              attachStudyDetails(reportsContent);
            }
          }
          
          if (typeof attachCardMenus === 'function') {
            attachCardMenus(document);
          }
          
          // Re-initialize any slide functionality
          if (typeof initializeSlides === 'function') {
            initializeSlides();
          }
          
          // Fix slide images that might have lost their sources
          const slideImages = contentArea.querySelectorAll('img[src*="secure-slide"], img[data-src*="secure-slide"]');
          slideImages.forEach(img => {
            if (img.dataset.src && !img.src) {
              img.src = img.dataset.src;
            }
            // Force reload if image failed to load
            if (img.complete && img.naturalWidth === 0) {
              const originalSrc = img.src;
              img.src = '';
              img.src = originalSrc + '?' + Date.now();
            }
          });
          
          // Force chart updates
          if (window.Chart && typeof window.Chart.helpers !== 'undefined') {
            // Trigger chart updates for any canvas elements
            const canvases = contentArea.querySelectorAll('canvas');
            canvases.forEach(canvas => {
              if (canvas.chart) {
                try {
                  canvas.chart.update();
                  canvas.chart.resize();
                } catch (e) {
                  console.warn('Chart update failed:', e);
                }
              }
            });
          }
          
          // Re-run any color matching or chart enhancement scripts
          if (typeof enhanceChartsInContainer === 'function') {
            enhanceChartsInContainer(contentArea);
          }
          
          console.log('Fully restored search results and re-initialized all components for:', search.query);
        }, 200);
        
        console.log('Restored search results for:', search.query);
      } else {
        // Fallback to performing a new search if no stored results
        console.log('No stored results, performing new search for:', search.query);
        if (searchInput) {
          searchInput.value = search.query;
        }
        performSearch();
      }
    }

    // Load and display recent projects (reports) with scroll prevention
    function loadRecentProjects() {
      const container = document.getElementById('recentProjects');
      const reports = JSON.parse(localStorage.getItem('userReports') || '[]');
      
      if (reports.length === 0) {
        container.innerHTML = '<div class="sidebar-item" style="opacity: 0.6; cursor: default;">No recent reports</div>';
        return;
      }
      
      // Calculate maximum items that fit without scrolling
      const maxItems = calculateMaxItemsWithoutScroll('recentProjects');
      const displayReports = reports.slice(0, maxItems);
      
      // Clean up excess data if we're limiting display
      if (reports.length > maxItems) {
        const cleanedReports = reports.slice(0, maxItems);
        localStorage.setItem('userReports', JSON.stringify(cleanedReports));
      }
      
      container.innerHTML = '';
      displayReports.forEach((report) => {
        const item = document.createElement('div');
        item.className = 'sidebar-item';
        item.innerHTML = `
          <div class="sidebar-item-text">${report.title || 'Untitled Report'}</div>
          <div class="sidebar-item-subtitle">${formatDate(report.createdAt || new Date())}</div>
        `;
        item.addEventListener('click', () => {
          window.location.href = '/reports.html';
        });
        container.appendChild(item);
      });
    }

    // Calculate maximum items that fit without scrolling
    function calculateMaxItemsWithoutScroll(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return 5; // default fallback
      
      const sectionContent = container.closest('.sidebar-section-content');
      if (!sectionContent) return 5; // default fallback
      
      // Get the available height for items
      const availableHeight = sectionContent.clientHeight;
      
      // Estimate item height (sidebar-item with padding + margin)
      // sidebar-item: 8px padding top/bottom + line-height for text + subtitle
      const estimatedItemHeight = 60; // Approximate height per item including margins
      
      // Calculate how many items fit, minimum of 3 to ensure at least some items show
      const maxItems = Math.max(3, Math.floor(availableHeight / estimatedItemHeight));
      
      // Cap at reasonable maximums - limit searches to 5 max
      return containerId === 'pastSearches' ? Math.min(maxItems, 5) : Math.min(maxItems, 5);
    }

    // Helper function to format dates
    function formatDate(date) {
      const d = new Date(date);
      const now = new Date();
      const diff = now - d;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
      return d.toLocaleDateString();
    }

    // Save search to history with complete results and automatic cleanup
    function saveSearchToHistory(query, results = null) {
      const searches = JSON.parse(localStorage.getItem('pastSearches') || '[]');
      
      // Get current results from the page if not provided
      if (!results) {
        results = getCurrentSearchResults();
      }
      
      const newSearch = {
        query: query,
        date: new Date().toISOString(),
        results: results // Store the complete search results
      };
      
      // Remove any existing identical query
      const filtered = searches.filter(s => s.query !== query);
      
      // Add to beginning
      filtered.unshift(newSearch);
      
      // Calculate dynamic limit based on what will fit without scrolling
      const maxItems = calculateMaxItemsWithoutScroll('pastSearches');
      const limited = filtered.slice(0, maxItems);
      
      localStorage.setItem('pastSearches', JSON.stringify(limited));
      loadPastSearches(); // Refresh the display
    }

    // Get current search results from the page
    function getCurrentSearchResults() {
      const results = {
        html: '',
        state: 'completed',
        className: '',
        bodyState: ''
      };
      
      const contentArea = document.getElementById('contentArea');
      if (contentArea) {
        // Store the entire content HTML and state
        results.html = contentArea.innerHTML;
        results.className = contentArea.className;
        results.state = contentArea.className.includes('loading') ? 'loading' : 'completed';
        
        // Also store body classes that might affect layout
        results.bodyState = document.body.className;
      }
      
      return results;
    }

    // Override the existing performSearch function to save searches
    const originalPerformSearch = performSearch;
    performSearch = async function(refresh = false) {
      const query = document.getElementById('searchInput').value.trim();
      
      // Call original search function first
      const result = await originalPerformSearch.call(this, refresh);
      
      // Save to history after search completes (with a delay to ensure results are rendered)
      if (query && !refresh) {
        setTimeout(() => {
          saveSearchToHistory(query);
        }, 2000); // Wait 2 seconds for search results to fully render
      }
      
      return result;
    };

    // Initialize filter dropdown functionality
    function initializeFilterDropdown() {
      const filterBtn = document.getElementById('filterBtn');
      const filterDropdown = document.getElementById('filterDropdown');
      const yearsFiltersContainer = document.getElementById('yearsFilters');
      const methodologiesFiltersContainer = document.getElementById('methodologiesFilters');
      
      let isDropdownOpen = false;
      
      // Store current filter values with defaults
      const filterValues = {
        thinking: 'moderate',
        charts: 'yes',
        quotes: 'moderate',
        style: 'dashboard',
        years: new Set(), // Track selected years
        methodologies: new Set() // Track selected methodologies
      };
      
      // Toggle dropdown on filter button click
      filterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleDropdown();
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!filterDropdown.contains(e.target) && !filterBtn.contains(e.target)) {
          closeDropdown();
        }
      });
      
      // Handle pill button clicks
      filterDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('pill-btn')) {
          const filter = e.target.dataset.filter;
          const value = e.target.dataset.value;
          
          // Handle multi-select filters (years, methodologies)
          if (filter === 'years' || filter === 'methodologies') {
            if (e.target.classList.contains('active')) {
              // Deselect
              e.target.classList.remove('active');
              filterValues[filter].delete(value);
            } else {
              // Select
              e.target.classList.add('active');
              filterValues[filter].add(value);
            }
          } else {
            // Handle single-select filters (existing behavior)
            const group = e.target.parentElement;
            group.querySelectorAll('.pill-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            filterValues[filter] = value;
            // Cascading presets from Thinking level
            if (filter === 'thinking') {
              if (value === 'detailed') {
                // charts yes, quotes many
                setActive('charts','yes'); filterValues.charts = 'yes';
                setActive('quotes','many'); filterValues.quotes = 'many';
              } else if (value === 'moderate') {
                setActive('charts','yes'); filterValues.charts = 'yes';
                setActive('quotes','moderate'); filterValues.quotes = 'moderate';
              } else if (value === 'concise') {
                setActive('charts','no'); filterValues.charts = 'no';
                setActive('quotes','none'); filterValues.quotes = 'none';
              }
            } else if (filter === 'style') {
              // If paragraph style selected, force charts=no and lock charts buttons
              if (value === 'paragraph') {
                setActive('charts','no'); filterValues.charts = 'no';
                disableCharts(true);
              } else {
                disableCharts(false);
              }
            }
          }
          
          console.log('Filter updated:', filter, '=', 
            (filter === 'years' || filter === 'methodologies') ? 
              Array.from(filterValues[filter]) : filterValues[filter]);
          console.log('Current filters:', filterValues);
        }
      });

      function setActive(filterName, value){
        const btns = filterDropdown.querySelectorAll(`.pill-btn[data-filter="${filterName}"]`);
        btns.forEach(b=> b.classList.toggle('active', b.dataset.value===value));
      }
      
      // Load all dynamic filters
      console.log('🔄 Starting filter initialization...');
      loadDynamicFilters();
      
      function toggleDropdown() {
        if (isDropdownOpen) {
          closeDropdown();
        } else {
          openDropdown();
        }
      }
      
      function openDropdown() {
        filterDropdown.classList.add('show');
        filterBtn.style.background = '#f8f9fa';
        filterBtn.style.color = 'var(--jaice-orange)';
        isDropdownOpen = true;
      }
      
      function closeDropdown() {
        filterDropdown.classList.remove('show');
        filterBtn.style.background = '';
        filterBtn.style.color = '';
        isDropdownOpen = false;
      }
      
      async function loadDynamicFilters() {
        // Get current client selection
        const clientSelect = document.getElementById('clientSelect');
        const selectedClient = clientSelect ? clientSelect.value : '';
        
        if (!selectedClient) {
          console.log('No client selected, clearing filters');
          yearsFiltersContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 14px;">Select a client to see available years</span>';
          methodologiesFiltersContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 14px;">Select a client to see available methodologies</span>';
          return;
        }
        
        try {
          // Load filter options which contains the actual library metadata with years and methodologies
          const url = `/api/filter-options?clientId=${encodeURIComponent(selectedClient)}`;
          const response = await fetch(url, {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });
          
          if (!response.ok) {
            throw new Error(`Failed to load filter options: ${response.status}`);
          }
          
          const filterData = await response.json();
          console.log('Filter options loaded for client:', selectedClient);
          console.log('Raw filter data:', filterData);
          
          // Extract years and methodologies from the filter data
          const years = filterData.years || [];
          const methodologies = filterData.methodology || [];
          
          console.log('Extracted years:', years);
          console.log('Extracted methodologies:', methodologies);
          
          // Populate the filter sections
          populateYearsFilter(years);
          populateMethodologiesFilter(methodologies);
          
        } catch (error) {
          console.error('Error loading dynamic filters:', error);
          yearsFiltersContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 14px;">Error loading filter options</span>';
          methodologiesFiltersContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 14px;">Error loading filter options</span>';
        }
      }
      
      function extractYearsFromLibrary(reportsData) {
        const years = new Set();
        
        console.log('Extracting years from reports data...');
        console.log('Reports data structure:', typeof reportsData, Object.keys(reportsData || {}));
        
        // Try different possible data structures for reports API response
        let reports = [];
        
        if (Array.isArray(reportsData)) {
          console.log('✅ Reports data is direct array');
          reports = reportsData;
        } else if (reportsData.data && Array.isArray(reportsData.data)) {
          console.log('✅ Reports data found in data field');
          reports = reportsData.data;
        } else if (reportsData.reports && Array.isArray(reportsData.reports)) {
          console.log('✅ Reports data found in reports field');
          reports = reportsData.reports;
        } else if (reportsData.items && Array.isArray(reportsData.items)) {
          console.log('✅ Reports data found in items field');
          reports = reportsData.items;
        } else {
          console.log('❌ No recognizable reports array found in:', reportsData);
          return [];
        }
        
        console.log(`Processing ${reports.length} reports for year extraction`);
        
        reports.forEach((report, index) => {
          console.log(`Report ${index}:`, report);
          
          // Look for year in various possible fields
          if (report.year) {
            console.log('Found year field:', report.year);
            years.add(report.year.toString());
          }
          
          if (report.date) {
            const year = new Date(report.date).getFullYear();
            if (year > 1900 && year <= new Date().getFullYear()) {
              console.log('Found year from date field:', year);
              years.add(year.toString());
            }
          }
          
          if (report.createdAt) {
            const year = new Date(report.createdAt).getFullYear();
            if (year > 1900 && year <= new Date().getFullYear()) {
              console.log('Found year from createdAt field:', year);
              years.add(year.toString());
            }
          }
          
          if (report.updatedAt) {
            const year = new Date(report.updatedAt).getFullYear();
            if (year > 1900 && year <= new Date().getFullYear()) {
              console.log('Found year from updatedAt field:', year);
              years.add(year.toString());
            }
          }
          
          // Check filename for year patterns
          if (report.fileName || report.filename || report.name) {
            const filename = report.fileName || report.filename || report.name;
            const yearMatch = filename.match(/\b(20)\d{2}\b/);
            if (yearMatch) {
              console.log('Found year from filename:', yearMatch[0]);
              years.add(yearMatch[0]);
            }
          }
          
          // Also check tags for year information
          if (report.tags && Array.isArray(report.tags)) {
            report.tags.forEach(tag => {
              if (typeof tag === 'string') {
                const yearMatch = tag.match(/\b(20)\d{2}\b/);
                if (yearMatch) {
                  console.log('Found year from tag:', yearMatch[0]);
                  years.add(yearMatch[0]);
                }
              }
            });
          }
          
          // Check metadata if available
          if (report.metadata && typeof report.metadata === 'object') {
            Object.values(report.metadata).forEach(value => {
              if (typeof value === 'string') {
                const yearMatch = value.match(/\b(20)\d{2}\b/);
                if (yearMatch) {
                  console.log('Found year from metadata:', yearMatch[0]);
                  years.add(yearMatch[0]);
                }
              }
            });
          }
        });
        
        const sortedYears = Array.from(years).sort((a, b) => b - a);
        console.log('Final extracted years:', sortedYears);
        return sortedYears;
      }
      
      function extractMethodologiesFromLibrary(reportsData) {
        const methodologies = new Set();
        console.log('Extracting methodologies from reports data...');
        
        // Get reports array using same logic as extractYearsFromLibrary
        let reports = [];
        if (Array.isArray(reportsData)) {
          reports = reportsData;
        } else if (reportsData.data && Array.isArray(reportsData.data)) {
          reports = reportsData.data;
        } else if (reportsData.reports && Array.isArray(reportsData.reports)) {
          reports = reportsData.reports;
        } else if (reportsData.items && Array.isArray(reportsData.items)) {
          reports = reportsData.items;
        } else {
          console.log('No reports found for methodology extraction');
          return [];
        }
        
        console.log(`Processing ${reports.length} reports for methodology extraction`);
        
        reports.forEach(report => {
          // Look for methodology in various fields
          if (report.methodology) {
            methodologies.add(report.methodology);
          }
          
          if (report.type) {
            methodologies.add(report.type);
          }
          
          // Check tags for methodology information
          if (report.tags && Array.isArray(report.tags)) {
            report.tags.forEach(tag => {
              // Common methodology keywords
              const methodologyKeywords = [
                'clinical trial', 'rct', 'randomized', 'meta-analysis', 'systematic review',
                'review', 'case study', 'observational', 'cohort', 'cross-sectional',
                'retrospective', 'prospective', 'survey', 'qualitative', 'quantitative'
              ];
              
              const tagLower = tag.toLowerCase();
              methodologyKeywords.forEach(keyword => {
                if (tagLower.includes(keyword)) {
                  // Capitalize first letter of each word
                  const formatted = keyword.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                  methodologies.add(formatted);
                }
              });
            });
          }
        });
        
        return Array.from(methodologies).sort();
      }
      
      function populateYearsFilter(years) {
        console.log('📅 populateYearsFilter called with:', years);
        console.log('📅 Years array length:', years.length);
        console.log('📅 Years array contents:', JSON.stringify(years));
        
        yearsFiltersContainer.innerHTML = '';
        
        if (years.length === 0) {
          console.log('📅 No years provided, showing "No years found" message');
          const noYears = document.createElement('span');
          noYears.textContent = 'No years found';
          noYears.style.color = 'var(--text-muted)';
          noYears.style.fontSize = '14px';
          yearsFiltersContainer.appendChild(noYears);
          return;
        }
        
        console.log('📅 Creating year pills for:', years);
        years.forEach(year => {
          const pill = document.createElement('button');
          pill.className = 'pill-btn active'; // Pre-selected
          pill.textContent = year;
          pill.dataset.filter = 'years';
          pill.dataset.value = year;
          
          // Add to filter values
          filterValues.years.add(year);
          
          yearsFiltersContainer.appendChild(pill);
        });
        
        console.log('📅 Years loaded successfully:', years);
      }
      
      function populateMethodologiesFilter(methodologies) {
        methodologiesFiltersContainer.innerHTML = '';
        
        if (methodologies.length === 0) {
          const noMethods = document.createElement('span');
          noMethods.textContent = 'No methodologies found';
          noMethods.style.color = 'var(--text-muted)';
          noMethods.style.fontSize = '14px';
          methodologiesFiltersContainer.appendChild(noMethods);
          return;
        }
        
        methodologies.forEach(methodology => {
          const pill = document.createElement('button');
          pill.className = 'pill-btn active'; // Pre-selected
          pill.textContent = methodology;
          pill.dataset.filter = 'methodologies';
          pill.dataset.value = methodology.toLowerCase().replace(/\s+/g, '-');
          
          // Add to filter values
          filterValues.methodologies.add(methodology.toLowerCase().replace(/\s+/g, '-'));
          
          methodologiesFiltersContainer.appendChild(pill);
        });
        
        console.log('Methodologies loaded:', methodologies);
      }
      
      function loadDefaultFilters() {
        console.log('⚠️ loadDefaultFilters() called! This should NOT happen for dynamic filters');
        console.trace('Call stack for loadDefaultFilters()');
        
        // Load default years (last 10 years)
        const currentYear = new Date().getFullYear();
        const defaultYears = [];
        for (let i = 0; i < 10; i++) {
          defaultYears.push((currentYear - i).toString());
        }
        
        console.log('⚠️ Generated default years:', defaultYears);
        
        // Load default methodologies
        const defaultMethodologies = [
          'Clinical Trial', 'Meta-Analysis', 'Systematic Review', 
          'Observational Study', 'Case Study', 'Review'
        ];
        
        populateYearsFilter(defaultYears);
        populateMethodologiesFilter(defaultMethodologies);
      }
      
      
      // Listen for client selection changes
      const clientSelect = document.getElementById('clientSelect');
      if (clientSelect) {
        clientSelect.addEventListener('change', () => {
          console.log('Client changed, reloading filters...');
          // Clear existing dynamic filters
          filterValues.years.clear();
          filterValues.methodologies.clear();
          loadDynamicFilters();
        });
      }
      
      // Expose filter values for use in search
      window.getFilterValues = () => ({
        ...filterValues,
        years: Array.from(filterValues.years),
        methodologies: Array.from(filterValues.methodologies)
      });
    }

    // Prevent sidebar.js from initializing
    window.enhancedSidebar = { initialized: true };

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      initializeSidebar();
      loadPastSearches();
      loadRecentProjects();
      initializeFilterDropdown();
      
      // Add resize listener to recalculate sidebar items when window resizes
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          loadPastSearches();
          loadRecentProjects();
        }, 250);
      });
      
      const adminNavLink = document.getElementById('adminNavLink');
      if (adminNavLink) {
        adminNavLink.addEventListener('click', (e) => {
          // Force a hard nav to /admin and neutralize any SPA/global handlers
          e.preventDefault();
          e.stopPropagation();
          try { console.log('[NAV] Admin clicked → /admin'); } catch {}
          window.location.assign('/admin');
        }, true); // capture phase to run before other click handlers
      }
    });
  </script>
<!-- color_matching_system is only for charts; removing to start fresh -->
<!-- Charts disabled: removed enhanced_chart_rendering.js include -->
<script>
function renderRelatedSlides(refs){
  // Function disabled - no floating related slides
  return;
}
function onSearchResultsArrived(results){
  try{
    const refs = (results && results.references && results.references.chunks) ? results.references.chunks : [];
    const dedup = [];
    const seen = new Set();
    for(const r of refs){
      const key = r.fileId ? ('id:'+r.fileId) : ('fp:'+(r.fileName||'')+'-'+(r.page||1));
      if(seen.has(key)) continue;
      seen.add(key);
      dedup.push(r);
    }
    const sorted = sortRefsByRecency(dedup);
    window.currentReferences = sorted;
    // Related slides disabled
    // renderRelatedSlides(sorted.slice(0,8));
    // Also update any references list if there is a hook function
    if (typeof renderReferencesList==='function') renderReferencesList(sorted);
  }catch(e){ console.error('render results error', e); }
}
</script>
<script>setTimeout(()=>{ try{ attachStudyDetails(document.getElementById('reportsReferencedContent')); attachCardMenus(document); }catch(_){ } }, 0);</script>
<script src="/debug-fix.js"></script>
<!-- JAICE bootstrap: define safe globals and enforce single /app.js load -->
<script>
(function boot(){
  // Prevent double-boot if the page tries to include app.js twice
  if (window.__JAICE_APP_BOOTSTRAPPED__) return;
  window.__JAICE_APP_BOOTSTRAPPED__ = true;

  // Safe globals used by app.js (prevents "not defined" & "already declared")
  window.currentUser = window.currentUser || { username: 'CognitiveAdmin', role: 'admin' };
  window.renderActiveReportBar = window.renderActiveReportBar || function(){};

  // Remove any extra /app.js tags already in the DOM (keep the first one only)
  var seen = false;
  var tags = document.querySelectorAll('script[src="/app.js"]');
  tags.forEach(function(t){
    if (seen) { try { t.parentNode.removeChild(t); } catch(e) {} }
    seen = true;
  });
})();
</script>
<!-- JAICE bootstrap: single-load + safe globals -->
<script>
(function boot(){
  if (window.__JAICE_APP_BOOTSTRAPPED__) return;
  window.__JAICE_APP_BOOTSTRAPPED__ = true;

  // Safe globals used by app.js
  window.currentUser = window.currentUser || { username: 'CognitiveAdmin', role: 'admin' };
  window.renderActiveReportBar = window.renderActiveReportBar || function(){};

  // Ensure /app.js only loads once (if server or DOM injected another tag)
  var seen = false;
  var tags = document.querySelectorAll('script[src="/app.js"]');
  tags.forEach(function(t){
    if (seen) { try { t.parentNode.removeChild(t); } catch(e) {} }
    seen = true;
  });
})();
</script>

  <!-- <script src="/sidebar.js"></script> -->
</body>
</html>