<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="/Circle.icon.ico" type="image/x-icon" />
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reports â€” Jaice</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style id="reports-minimal-patch">
    /* Keep modal hidden by default; shown only by JS adding .show */
    .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center; }
    .modal-overlay.show{ display:flex; }
    .modal{ background:#fff; border-radius:12px; max-width:560px; width:92%; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.18); }
  
/* === Force saved cards to stretch === */
.report-grid .response-card,
.report-grid .answer-card,
.report-grid .dashboard-item,
.report-grid .report-item-card {
  width: 100% !important;
  max-width: 100% !important;
}
.report-grid .response-card > *,
.report-grid .dashboard-item > * {
  max-width: 100% !important;
}

</style>

  <style>
    :root {
      --jaice-orange: #D14829;
      --text-primary: #1c1d1f;
      --text-muted: #666;
      --logo-grey: #6b7280;
      --background: #ffffff;
      --border: #e0e4e7;
      --white: #fff;
      --shadow-soft: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
      --shadow-strong: 0 8px 24px rgba(0,0,0,0.2);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* SIMPLIFIED LAYOUT - NO SIDEBAR */
    .app-layout {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: white;
    }

    /* NEW HEADER DESIGN - Full width with centered navigation */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      box-shadow: var(--shadow-soft);
    }

    /* Logo on left */
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-primary);
      flex-shrink: 0;
    }

    .logo img {
      height: 32px;
      width: auto;
    }

    /* CENTERED NAVIGATION */
    .main-nav {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
    }

    .nav-link:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    .nav-link.active {
      color: var(--jaice-orange);
      font-weight: 600;
      border-bottom: 2px solid var(--jaice-orange);
    }

    /* Right side - user info and profile */
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1001;
      flex-shrink: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .profile {
      position: relative;
      z-index: 1002;
    }

    .profile-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .profile-btn:hover {
      background: #f8f9fa;
      border-color: var(--jaice-orange);
    }

    .profile-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
      min-width: 180px;
      z-index: 1003;
      display: none;
      overflow: hidden;
    }

    .profile-menu.show {
      display: block;
    }

    .profile-menu a,
    .profile-menu button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .profile-menu a:hover,
    .profile-menu button:hover {
      background: #f8f9fa;
    }

    .company-name {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Client Selector */
    .client-selector-corner {
      position: fixed;
      top: 80px;
      right: 32px;
      z-index: 999;
      display: none;
    }

    .client-selector-corner.show {
      display: block;
    }

    .client-selector-corner select {
      padding: 10px 32px 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 14px;
      min-width: 220px;
      box-shadow: var(--shadow-soft);
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 16px;
      transition: all 0.2s ease;
    }

    /* MAIN CONTENT - No sidebar, full width */
    .main-content {
      flex: 1;
      margin-top: 70px;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 70px);
      background: white;
    }

    .content {
      flex: 1;
      padding: 40px 32px;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    /* REPORTS PAGE */

    body.reports-fixed-sidebar .content { padding-left: 182px; }
    body.reports-fixed-sidebar .page-header { margin-left: 0; }
    .reports-sidebar { 
      border-radius:0 !important; 
      z-index: 900 !important;
    }

    /* Hide only specific elements when viewing a report */
    body.viewing-report .page-header,
    body.viewing-report .client-selector-corner,
    body.viewing-report .slides-header,
    body.viewing-report section {
      display: none !important;
    }

    /* Clean report view layout */
    body.viewing-report .content {
      padding-top: 0 !important;
      margin-top: 70px !important; /* Keep space for header */
    }

    body.viewing-report .reports-split-view {
      display: flex !important;
      min-height: calc(100vh - 70px) !important;
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden !important;
      box-sizing: border-box !important;
    }

    body.viewing-report .reports-sidebar {
      width: 150px !important;
      min-width: 150px !important;
      flex-shrink: 0 !important;
      box-sizing: border-box !important;
    }

    body.viewing-report .report-content {
      flex: 1 !important;
      padding: 0 !important;
      background: #ffffff !important;
      overflow-y: visible !important;
      overflow-x: hidden !important;
      width: calc(100% - 150px) !important;
      margin-left: 150px !important;
      max-width: none !important;
      box-sizing: border-box !important;
    }

    /* Official Report Styling */
    .report-view-container {
      max-width: none;
      margin: 0 auto;
      background: transparent;
      min-height: calc(100vh - 150px);
      padding: 20px 0;
    }

    .report-header {
      text-align: left;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #D14829;
    }

    .report-title {
      font-size: 36px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 10px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .report-description {
      font-size: 16px;
      color: #6b7280;
      font-style: italic;
      margin: 0;
    }

    /* Modular Grid System */
    .report-grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 20px;
      margin-top: 20px;
      width: 100%;
    }

    .report-item {
      background: transparent;
      border: none;
      border-radius: 8px;
      padding: 30px;
      cursor: move;
      transition: all 0.3s ease;
      position: relative;
      min-height: 120px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .report-item:hover {
      border-color: transparent;
      box-shadow: none;
    }

    .report-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .report-item.full-width {
      grid-column: span 12;
    }

    .report-item.half-width {
      grid-column: span 6;
    }

    .report-item.third-width {
      grid-column: span 4;
    }

    .report-item.quarter-width {
      grid-column: span 3;
    }

    .report-item-content {
      width: 100%;
      text-align: left;
    }

    .report-item-title {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 15px;
    }

    .report-item-text {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
      text-align: left;
    }

    .report-item {
      cursor: move;
    }
    
    .report-item-menu-button {
      cursor: pointer !important;
    }

    /* Drop zones */
    .drop-zone {
      background: rgba(209,72,41,0.1);
      border: 2px dashed #D14829;
      border-radius: 8px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #D14829;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .drop-zone.active {
      opacity: 1;
    }
    
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border);
    }

    .page-title-section h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .create-report-btn {
      background: linear-gradient(135deg, var(--jaice-orange) 0%, #D14829 100%);
      color: var(--white);
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .create-report-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .slides-section {
      margin-top: 8px;
    }

    .slides-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 10px;
    }

    .slides-header h2 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .slides-sub {
      color: var(--text-muted);
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
      max-width: 500px;
      margin: 0 auto;
    }

    .empty-state-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, var(--jaice-orange), #D14829);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--text-primary);
      font-weight: 600;
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .report-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--jaice-orange), #D14829);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .report-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-strong);
    }

    .report-card:hover::before {
      opacity: 1;
    }

    .report-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .report-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.3;
      flex: 1;
      margin-right: 12px;
    }

    .report-menu {
      position: relative;
      flex-shrink: 0;
    }

    .report-menu-btn {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 18px;
      line-height: 1;
    }

    .report-menu-btn:hover {
      background: #f8f9fa;
      color: var(--jaice-orange);
    }

    .report-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow-medium);
      min-width: 160px;
      z-index: 100;
      display: none;
      overflow: hidden;
    }

    .report-dropdown.show {
      display: block;
    }

    .report-dropdown button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      transition: background-color 0.2s;
      font-weight: 500;
    }

    .report-dropdown button:hover {
      background: #f8f9fa;
    }

    .report-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .report-items-count {
      background: linear-gradient(135deg, var(--jaice-orange), #D14829);
      color: var(--white);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .report-date {
      font-weight: 500;
    }

    .report-preview {
      margin-bottom: 20px;
    }

    .preview-item {
      background: transparent;
      border: none;
      border-radius: 10px;
      padding: 0;
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      overflow: hidden;
    }

    .preview-item:last-child {
      margin-bottom: 0;
    }

    .preview-item .item-type {
      font-weight: 700;
      color: var(--jaice-orange);
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: inline-block;
      background: rgba(209, 72, 41, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .preview-content {
      color: var(--text-primary);
      font-weight: 400;
    }

    .report-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      flex: 1;
    }

    .btn:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--jaice-orange) 0%, #D14829 100%);
      border-color: var(--jaice-orange);
      color: var(--white);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #D14829 0%, #D14829 100%);
      transform: translateY(-1px);
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .main-nav {
        display: none;
      }
      
      .content {
        padding: 24px 20px;
      }
      
      .client-selector-corner {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
      }
      
      .reports-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 0 16px;
      }
      
      .content {
        padding: 20px 16px;
      }
      
      .page-title-section h1 {
        font-size: 28px;
      }
      
      .report-card {
        padding: 20px;
      }
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .modal-subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--white);
      color: var(--text-primary);
      transition: border-color 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--jaice-orange);
      box-shadow: 0 0 0 3px rgba(209, 72, 41, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel {
      background: #f8f9fa;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-cancel:hover {
      background: #e9ecef;
    }
  </style>
  <link rel="stylesheet" href="/modern-bridge.css"/>
</head>
<body>
  <button class="sidebar-toggle" onclick="toggleSidebar()">â˜° Menu</button>
  <button class="save-report-btn" onclick="saveReport()">ðŸ’¾ Save Report</button>
  <!-- Fixed Header with Centered Navigation -->
  <header class="header">
    <!-- Logo on Left -->
    <a href="/" class="logo">
      <img src="/assets/Slide1.JPG" alt="Jaice" />
    </a>
    
    <!-- Centered Navigation -->
    <nav class="main-nav">
      <a href="/" class="nav-link">Home</a>
      <a href="/library.html" class="nav-link">Library</a>
      <a href="/reports.html" class="nav-link active">Reports</a>
      <a href="/admin" class="nav-link" id="adminNavLink" style="display: none;">Admin</a>
    </nav>
    
    <!-- Right Side - User Info & Profile -->
    <div class="header-right">
      <div class="user-info"><span id="userDisplay">Loading...</span></div>
      <div class="company-name" id="companyNameDisplay" style="display: none;">GENENTECH</div>

      <div class="profile">
        <button class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false" title="Account">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
          </svg>
        </button>
        <div class="profile-menu" id="profileMenu">
          <a href="/admin" id="adminCenterLink" style="display: none;">Admin Center</a>
          <button id="logoutBtn" type="button">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Client Selector -->
  <div class="client-selector-corner" id="clientSelectorCorner">
    <select id="clientSelect">
      <option value="">Select a client library</option>
    </select>
  </div>

  <div class="app-layout">
    <!-- Main Content (No Sidebar) -->
    <main class="main-content">
      <div class="content">
        <!-- Page Header -->
        <div class="page-header">
          <div class="page-title-section">
            <h1>Reports</h1>
            <p class="page-subtitle">View and manage your saved reports</p>
          </div>

        </div></to_replace>
</Editor.edit_file_by_replace>

<Editor.edit_file_by_replace>

<to_replace>  <!-- Client Selector -->
  <div class="client-selector-corner" id="clientSelectorCorner">
    <select id="clientSelect">
      <option value="">Select a client library</option>
    </select>
  </div></to_replace>
<new_content>

        <!-- Saved Reports (local) -->
        <section>
          <div class="slides-header">
            <h2>Saved Reports</h2>

          </div>

          <div class="reports-grid" id="reportsGrid"></div>
          <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            </div>
            <h3>No reports yet</h3>
            <p>Use the "Add to report" option from the â‹¯ menu on search results to create your first report, or click "Create Report" above.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Create Report Modal -->
  <div class="modal-overlay" id="createReportModal" style="display:none">
    <div class="modal">
      <h2 class="modal-title">Create New Report</h2>
      <p class="modal-subtitle">Give your report a name and description to get started.</p>

      <div class="form-group">
        <label class="form-label" for="reportName">Report Name</label>
        <input type="text" id="reportName" class="form-input" placeholder="Enter report name" maxlength="100" />
      </div>

      <div class="form-group">
        <label class="form-label" for="reportDescription">Description (Optional)</label>
        <input type="text" id="reportDescription" class="form-input" placeholder="Brief description of this report" maxlength="200" />
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelReportBtn">Cancel</button>
        <button class="btn btn-primary" id="confirmCreateReportBtn">Create Report</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentUser = null;
    let currentClient = null;
    let userReports = [];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initializeApp);

    async function initializeApp() {
      console.log('Initializing reports page...');
      
      try {
        // Get authentication data
        const response = await fetch('/me', { credentials: 'include' });
        if (response.status === 401) {
          window.location.href = '/login.html';
          return;
        }
        
        if (response.ok) {
          const userData = await response.json();
          currentUser = userData.user;
          currentClient = userData.activeClientId;
          console.log('User authenticated:', currentUser);
        } else {
          console.log('Using fallback authentication');
          currentUser = { username: 'CognitiveAdmin', role: 'admin' };
        }
      } catch (error) {
        console.log('Auth check failed, using fallback user');
        currentUser = { username: 'CognitiveAdmin', role: 'admin' };
      }

      updateUserDisplay();
      await loadClientLibraries();
      setupEventListeners();
      
      // Load reports from server API
      await loadReportsFromAPI();
    }

    function updateUserDisplay() {
      const userDisplay = document.getElementById('userDisplay');
      const companyNameDisplay = document.getElementById('companyNameDisplay');
      const adminCenterLink = document.getElementById('adminCenterLink');
      const adminNavLink = document.getElementById('adminNavLink');
      const clientSelectorCorner = document.getElementById('clientSelectorCorner');

      if (currentUser) {
        const roleDisplay = currentUser.role === 'admin' ? 'admin' : currentUser.role;
        userDisplay.textContent = `${currentUser.username} (${roleDisplay})`;

        if (currentUser.role === 'admin') {
          if (adminCenterLink) adminCenterLink.style.display = 'block';
          if (adminNavLink) adminNavLink.style.display = 'block';
          if (clientSelectorCorner) clientSelectorCorner.classList.add('show');
          if (companyNameDisplay) companyNameDisplay.style.display = 'none';
        } else {
          if (companyNameDisplay) {
            companyNameDisplay.style.display = 'block';
            companyNameDisplay.textContent = 'GENENTECH';
          }
          if (clientSelectorCorner) clientSelectorCorner.classList.remove('show');
          if (adminCenterLink) adminCenterLink.style.display = 'none';
          if (adminNavLink) adminNavLink.style.display = 'none';
        }
      }
    }

    async function loadClientLibraries() {
      try {
        const response = await fetch('/api/client-libraries');
        if (response.ok) {
          const libraries = await response.json();
          const clientSelect = document.getElementById('clientSelect');
          clientSelect.innerHTML = '<option value="">Select a client library</option>';
          libraries.forEach(lib => {
            const option = document.createElement('option');
            option.value = lib.id;
            option.textContent = lib.name;
            clientSelect.appendChild(option);
          });
          if (currentClient) clientSelect.value = currentClient;
        }
      } catch (error) {
        console.warn('Failed to load client libraries:', error);
      }
    }

    function setupEventListeners() {
      // Profile menu
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = profileMenu.classList.toggle('show');
        profileBtn.setAttribute('aria-expanded', String(open));
      });
      document.addEventListener('click', () => { 
        profileMenu.classList.remove('show'); 
        profileBtn.setAttribute('aria-expanded','false'); 
      });

      // Modal events
      const createReportModal = document.getElementById('createReportModal');
      const cancelReportBtn = document.getElementById('cancelReportBtn');
      const confirmCreateReportBtn = document.getElementById('confirmCreateReportBtn');
      cancelReportBtn.addEventListener('click', hideCreateReportModal);
      confirmCreateReportBtn.addEventListener('click', createNewReport);
      createReportModal.addEventListener('click', (e) => { 
        if (e.target === createReportModal) hideCreateReportModal(); 
      });

      // Client switching for admins
      const clientSelect = document.getElementById('clientSelect');
      clientSelect.addEventListener('change', async (e) => {
        const selectedClientId = e.target.value;
        if (selectedClientId) {
          try {
            await fetch('/auth/switch-client', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ clientId: selectedClientId })
            });
            currentClient = selectedClientId;
          } catch (error) {
            console.error('Failed to switch client:', error);
          }
        }
      });

      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', async () => {
        try { 
          await fetch('/auth/logout', { method: 'POST' }); 
        } finally { 
          window.location.href = '/login.html'; 
        }
      });
    }

    // Load reports from server API
    async function loadReportsFromAPI() {
      try {
        console.log('Loading reports from API...');
        const response = await fetch('/api/reports', { credentials: 'include' });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Raw API response:', data);
        
        // Handle different response formats
        let reportsList = [];
        if (Array.isArray(data)) {
          reportsList = data;
        } else if (data && Array.isArray(data.data)) {
          reportsList = data.data;
        } else if (data && Array.isArray(data.reports)) {
          reportsList = data.reports;
        }
        
        // Normalize the reports data structure
        userReports = reportsList.map(report => ({
          id: report.id || report._id || report.reportId,
          name: report.title || report.name || 'Untitled Report',
          title: report.title || report.name || 'Untitled Report',
          description: report.description || '',
          items: Array.isArray(report.items) ? report.items : [],
          createdAt: report.createdAt || report.created || Date.now(),
          updatedAt: report.updatedAt || report.updated || report.createdAt || Date.now()
        })).filter(report => report.id); // Filter out reports without IDs
        
        console.log('Processed reports:', userReports);
        
        // Sort by most recent first
        userReports.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        
        renderReports();
        
      } catch (error) {
        console.error('Failed to load reports from API:', error);
        // Fallback to localStorage
        try {
          const stored = localStorage.getItem('userReports');
          userReports = stored ? JSON.parse(stored) : [];
          renderReports();
        } catch (e) {
          console.error('Failed to load from localStorage:', e);
          userReports = [];
          renderReports();
        }
      }
    }

    // Modal functions
    function showCreateReportModal() {
      const modal = document.getElementById('createReportModal');
      modal.classList.add('show');
      modal.style.display = 'flex';
      document.getElementById('reportName').value = '';
      document.getElementById('reportDescription').value = '';
      setTimeout(() => { document.getElementById('reportName').focus(); }, 100);
    }
    
    function hideCreateReportModal() {
      const modal = document.getElementById('createReportModal');
      modal.classList.remove('show');
      modal.style.display = 'none';
    }
    
    async function createNewReport() {
      const name = document.getElementById('reportName').value.trim();
      const description = document.getElementById('reportDescription').value.trim();
      
      if (!name) { 
        alert('Please enter a report name'); 
        return; 
      }
      
      try {
        console.log('Creating report:', { name, description });
        
        const response = await fetch('/api/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title: name, description: description })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Report created:', result);
        
        hideCreateReportModal();
        showToast(`Report "${name}" created successfully!`);
        
        // Reload reports from server
        await loadReportsFromAPI();
        
      } catch (error) {
        console.error('Failed to create report:', error);
        alert(`Failed to create report: ${error.message}`);
      }
    }
    
    function renderReports() {
      const reportsGrid = document.getElementById('reportsGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (!userReports.length) { 
        reportsGrid.style.display = 'none'; 
        emptyState.style.display = 'block'; 
        return; 
      }
      
      reportsGrid.style.display = 'grid'; 
      emptyState.style.display = 'none'; 
      reportsGrid.innerHTML = '';
      
      userReports.forEach(report => {
        reportsGrid.appendChild(createReportCard(report));
      });
    }
    
    function createReportCard(report) {
      const card = document.createElement('div'); 
      card.className = 'report-card';
      
      const itemsCount = report.items ? report.items.length : 0;
      const createdDate = new Date(report.createdAt).toLocaleDateString();
      const updatedDate = new Date(report.updatedAt).toLocaleDateString();
      
      // Handle preview items - check for both title/html and headline/content formats
      const previewItems = (report.items || []).slice(0, 2);
      
      let previewHtml = '';
      // Listing page: no preview block
      previewHtml = '';
      
      card.innerHTML = `
        <div class="report-header">
          <h3 class="report-title">${escapeHtml(report.title || report.name)}</h3>
          <div class="report-menu">
            <button class="report-menu-btn" onclick="toggleReportMenu('${report.id}')">â‹¯</button>
            <div class="report-dropdown" id="menu-${report.id}">
              <button onclick="viewReport('${report.id}')">View Details</button>
              <button onclick="duplicateReport('${report.id}')">Duplicate</button>
              <button onclick="exportReport('${report.id}')">Export PDF</button>
              <button onclick="deleteReport('${report.id}')" style="color: #dc2626;">Delete</button>
            </div>
          </div>
        </div>
        <div class="report-meta">
          <span class="report-items-count">${itemsCount} item${itemsCount !== 1 ? 's' : ''}</span>
          <span class="report-date">Created ${createdDate}</span>
          ${updatedDate !== createdDate ? `<span class="report-date">Updated ${updatedDate}</span>` : ''}
        </div>
        ${report.description ? `<p style="color: var(--text-muted); font-size: 13px; margin: 4px 0 16px 0; line-height: 1.4; font-style: italic;">${escapeHtml(report.description)}</p>` : ''}
        <div class="report-actions">
          <button class="btn" onclick="viewReport('${report.id}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            View
          </button>
          <button class="btn btn-primary" onclick="exportReport('${report.id}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            Export PDF
          </button>
        </div>`;
      
      return card;
    }
    
    function toggleReportMenu(reportId) {
      document.querySelectorAll('.report-dropdown').forEach(menu => { 
        if (menu.id !== `menu-${reportId}`) menu.classList.remove('show'); 
      });
      const menu = document.getElementById(`menu-${reportId}`);
      menu.classList.toggle('show');
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) { 
            menu.classList.remove('show'); 
            document.removeEventListener('click', closeMenu); 
          }
        });
      }, 10);
    }
    
    function viewReport(reportId) {
      const report = userReports.find(r => r.id === reportId);
      if (!report) return;
      
      // Store current report ID for menu functions
      setCurrentReportId(reportId);

      // Tear down any existing split view to avoid stacking
      if (window.currentSplitView && window.currentSplitView.parentNode) {
        window.currentSplitView.parentNode.removeChild(window.currentSplitView);
        window.currentSplitView = null;
      }

      // Get the main content area
      const content = document.querySelector('.content');
      const reportsGrid = document.getElementById('reportsGrid');
      const pageHeader = document.querySelector('.page-header');
      
      // Create the split view container
      const splitView = document.createElement('div');
      splitView.className = 'reports-split-view';
      splitView.style.cssText = `
        display: flex;
        gap: 24px;
        height: calc(100vh - 150px);
        transition: all 0.3s ease;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      `;
      
      // Create animated sidebar
      const sidebar = document.createElement('div');
      sidebar.className = 'reports-sidebar';
      sidebar.style.cssText = `
        position: fixed;
        left: 0;
        top: 70px;
        width: 150px;
        height: calc(100vh - 70px);
        flex-shrink: 0;
        background: #ffffff;
        border-right: 1px solid #e5e7eb;
        border-radius: 0;
        overflow-y: auto;
        transform: translateX(0);
        opacity: 1;
      `;
      
      // Sidebar header
      const sidebarHeader = document.createElement('div');
      sidebarHeader.style.cssText = `
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 16px 16px 0 0;
      `;
      sidebarHeader.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div></div>
          <button onclick="closeSplitView()" style="background: none; border: none; font-size: 18px; color: #6b7280; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">Ã—</button>
        </div>
      `;
      
      // Reports list
      const reportsList = document.createElement('div');
      reportsList.style.cssText = 'padding: 8px 0;';
      
      userReports.forEach(r => {
        const isActive = r.id === reportId;
        const reportItem = document.createElement('div');
        reportItem.className = 'sidebar-report-item';
        reportItem.style.cssText = `
          padding: 16px 20px;
          cursor: pointer;
          border-left: 3px solid ${isActive ? 'var(--jaice-orange)' : 'transparent'};
          background: ${isActive ? '#ffffff' : 'transparent'};
          color: ${isActive ? '#1f2937' : '#6b7280'};
          font-weight: ${isActive ? '600' : '400'};
          transition: all 0.2s ease;
          margin: 2px 0;
        `;
        
        reportItem.innerHTML = `
          <div style="font-size: 14px; margin-bottom: 4px;">${escapeHtml(r.title || r.name)}</div>
          <div style="font-size: 12px; opacity: 0.7;">${r.items ? r.items.length : 0} items</div>
        `;
        
        if (!isActive) {
          reportItem.addEventListener('click', () => {
            // Clear any existing report view first
            if (window.currentSplitView) {
              window.currentSplitView.remove();
              window.currentSplitView = null;
              window.originalGrid = null;
            }
            viewReport(r.id);
          });
          
          reportItem.addEventListener('mouseenter', () => {
            reportItem.style.background = '#e5e7eb';
          });
          
          reportItem.addEventListener('mouseleave', () => {
            reportItem.style.background = 'transparent';
          });
        }
        
        reportsList.appendChild(reportItem);
      });
      
      // sidebar header removed per request
      sidebar.appendChild(reportsList);
      
      // Main content area for the report with modular design
      const reportContent = document.createElement('div');
      reportContent.className = 'report-content';
      reportContent.style.cssText = `
        flex: 1;
        padding: 0;
        background: #ffffff;
        overflow-y: visible;
        overflow-x: hidden;
        max-width: none;
        width: calc(100% - 150px);
        margin-left: 150px;
        box-sizing: border-box;
      `;
      
      // Only show description if it actually exists and is not empty
      const hasDescription = report.description && report.description.trim() !== '';
      
      reportContent.innerHTML = `
        <div class="report-view-container" style="padding: 85px 0 0 0;">
          <div class="report-grid" id="reportGrid">
            ${generateReportLayout(report.items || [])}
          </div>
        </div>
      `;
      
      // Force double font sizes after content insertion
      setTimeout(() => {
        const reportGrid = document.getElementById('reportGrid');
        if (reportGrid) {
          const allElements = reportGrid.querySelectorAll('*');
          allElements.forEach(element => {
            const currentStyle = element.style.fontSize;
            if (currentStyle) {
              let newSize;
              if (currentStyle.includes('px')) {
                const pixels = parseFloat(currentStyle);
                newSize = (pixels * 2) + 'px';
              } else if (currentStyle.includes('pt')) {
                const points = parseFloat(currentStyle);
                newSize = (points * 2) + 'pt';
              } else if (currentStyle.includes('em')) {
                const ems = parseFloat(currentStyle);
                newSize = (ems * 2) + 'em';
              } else {
                const number = parseFloat(currentStyle);
                if (!isNaN(number)) {
                  newSize = (number * 2) + 'px';
                }
              }
              if (newSize) {
                element.style.setProperty('font-size', newSize, 'important');
              }
            } else if (!currentStyle) {
              // For elements without explicit font-size, set a default doubled size
              element.style.setProperty('font-size', '12px', 'important');
            }
          });
        }
      }, 100);
      
      
      // Create fixed report title at the very top
      const reportTitle = document.createElement('div');
      reportTitle.className = 'fixed-report-title';
      reportTitle.style.cssText = `
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background: #D14829;
        padding: 16px 16px 12px 170px;
        border-bottom: none;
        z-index: 800;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      `;
      
      reportTitle.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
          <div style="flex: 1; margin-right: 16px;">
            <h1 style="font-size: 24px; font-weight: 700; color: white; margin: 0; line-height: 1.2; text-transform: uppercase; letter-spacing: 2px;">${escapeHtml(report.title || report.name || 'REPORT TITLE')}</h1>
            ${hasDescription ? `<p style="color: rgba(255,255,255,0.9); font-size: 13px; line-height: 1.4; margin: 4px 0 0 0; text-transform: none; letter-spacing: normal; font-style: italic;">${escapeHtml(report.description)}</p>` : ''}
          </div>
          <div class="report-header-menu" style="position: relative; flex-shrink: 0;">
            <button class="report-header-menu-button" onclick="toggleReportHeaderMenu()" style="
              background: rgba(255,255,255,0.2);
              border: 1px solid rgba(255,255,255,0.3);
              border-radius: 6px;
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-size: 16px;
              color: white;
              transition: all 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">â‹¯</button>
            <div class="report-header-dropdown" id="reportHeaderDropdown" style="
              display: none;
              position: absolute;
              top: 100%;
              right: 0;
              background: white;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              min-width: 180px;
              z-index: 1000;
              padding: 4px 0;
              margin-top: 8px;
            ">
              <button onclick="renameReport('${report.id}')" style="
                display: block;
                width: 100%;
                text-align: left;
                padding: 10px 14px;
                border: none;
                background: white;
                cursor: pointer;
                font-size: 14px;
                color: #374151;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
                Rename Report
              </button>
              <button disabled style="
                display: block;
                width: 100%;
                text-align: left;
                padding: 10px 14px;
                border: none;
                background: white;
                cursor: not-allowed;
                font-size: 14px;
                color: #9ca3af;
                opacity: 0.7;
              ">
                Download as PDF (Coming Soon)
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(reportTitle);
      
      splitView.appendChild(sidebar);
      splitView.appendChild(reportContent);
      
      // Store reference to the fixed title for cleanup
      window.currentReportTitle = reportTitle;
      
      // Add animations CSS
      if (!document.querySelector('#report-animations')) {
        const style = document.createElement('style');
        style.id = 'report-animations';
        style.textContent = `
          @keyframes slideInLeft {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          .report-item-card:hover .drag-handle {
            opacity: 1;
          }
        `;
        document.head.appendChild(style);
      }
      
      // Hide the grid and show split view
      reportsGrid.style.display = 'none';
      content.appendChild(splitView);
      
      // Add viewing-report class to body to hide title and dropdown
      document.body.classList.add('viewing-report');
      
      // Initialize drag and drop functionality
      setTimeout(() => initializeReportDragDrop(), 100);
      
      // Store reference for closing
      window.currentSplitView = splitView;
      window.originalGrid = reportsGrid;
      
      // Add click outside handler to close dropdowns
      document.addEventListener('click', (e) => {
        // Close report item dropdowns
        if (!e.target.closest('.report-item-menu')) {
          document.querySelectorAll('.report-item-dropdown').forEach(dropdown => {
            dropdown.classList.remove('show');
          });
        }
        
        // Close header dropdown
        if (!e.target.closest('.report-header-menu')) {
          const headerDropdown = document.getElementById('reportHeaderDropdown');
          if (headerDropdown) {
            headerDropdown.style.display = 'none';
          }
        }
      });
    }
    
    function createOriginalFormatCard(item, index) {
      const card = document.createElement('div');
      card.className = 'report-item-card draggable-card';
      card.setAttribute('data-item-index', index);
      
      // Try to recreate the original card exactly as it was saved
      if (item.html && item.html.includes('answer-card')) {
        // Neutralize legacy orange answer card styling
        card.style.cssText = `
          background: transparent;
          border: none;
          border-radius: 0;
          padding: 0;
          margin-bottom: 16px;
          position: relative;
          box-shadow: none;
        `;
        
        // Use the original saved HTML to preserve exact styling/animation
                scrubInlineWidths(card);
// Remove literal action buttons that bled into saved HTML, keep overflow menus
        Array.from(card.querySelectorAll('button')).forEach(b=>{
          const t = (b.textContent||'').trim().toLowerCase();
          if (t === 'add to report' || t === 'remove from answer') b.remove();
        });
        // Ensure card behaves as a response card for menus
        if (!card.classList.contains('response-card')) card.classList.add('response-card');
        try { if (window.attachCardMenus) window.attachCardMenus(card); } catch(_){}
        // Add drag handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.style.cssText = `
          position: absolute;
          top: 16px;
          right: 16px;
          cursor: move;
          color: var(--jaice-orange);
          font-size: 16px;
          opacity: 0;
          transition: opacity 0.2s;
          background: rgba(255, 255, 255, 0.9);
          padding: 4px 8px;
          border-radius: 4px;
          border: 1px solid #D14829;
        `;
        dragHandle.innerHTML = 'â‹®â‹®';
        card.appendChild(dragHandle);
        
      } else if (item.html && item.html.includes('dashboard-item')) {
        // This was a white dashboard card - recreate it exactly
        card.innerHTML = item.html;
        
        // Add drag handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          cursor: move;
          color: #6b7280;
          font-size: 16px;
          opacity: 0;
          transition: opacity 0.2s;
          background: rgba(255, 255, 255, 0.9);
          padding: 4px 8px;
          border-radius: 4px;
          border: 1px solid #e5e7eb;
        `;
        dragHandle.innerHTML = 'â‹®â‹®';
        card.appendChild(dragHandle);
        
      } else {
        // Fallback for items without full HTML - shouldn't happen with proper saving
        card.style.cssText = `
          background: transparent;
          border: none;
          border-radius: 0;
          padding: 0;
          margin-bottom: 16px;
          box-shadow: none;
          position: relative;
        `;
        
        card.innerHTML = `
          <div class="drag-handle" style="position: absolute; top: 12px; right: 12px; cursor: move; color: var(--text-muted); font-size: 16px; opacity: 0; transition: opacity 0.2s;">â‹®â‹®</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${escapeHtml(item.title || '')}</div>
          <div style="font-size: 12px; line-height: 1.4; color: var(--text-primary);">${item.html ? stripHtml(item.html) : (item.content || '')}</div>
        `;
      }
      
      // Keep original card actions/menus intact
      card.style.position = 'relative';
      
      return card;
    }
    
    function initializeSimpleDragAndDrop(container) {
      let draggedElement = null;
      let placeholder = null;
      
      container.addEventListener('mousedown', function(e) {
        const dragHandle = e.target.closest('.drag-handle');
        if (!dragHandle) return;
        
        draggedElement = dragHandle.closest('.draggable-card');
        if (!draggedElement) return;
        
        e.preventDefault();
        
        // Create placeholder
        placeholder = document.createElement('div');
        placeholder.className = 'drag-placeholder';
        placeholder.style.cssText = `
          height: ${draggedElement.offsetHeight}px;
          margin-bottom: 24px;
          border: 2px dashed var(--jaice-orange);
          border-radius: 16px;
          background: rgba(209, 72, 41, 0.05);
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--jaice-orange);
          font-weight: 600;
        `;
        placeholder.textContent = 'Drop here';
        
        draggedElement.style.opacity = '0.5';
        draggedElement.style.transform = 'rotate(2deg)';
        draggedElement.style.zIndex = '1000';
        
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', handleDrop);
      });
      
      function handleDrag(e) {
        if (!draggedElement || !placeholder) return;
        
        const cards = Array.from(container.querySelectorAll('.draggable-card'));
        const afterElement = getDragAfterElement(container, e.clientY);
        
        if (afterElement == null) {
          container.appendChild(placeholder);
        } else {
          container.insertBefore(placeholder, afterElement);
        }
      }
      
      function handleDrop(e) {
        if (!draggedElement || !placeholder) return;
        
        draggedElement.style.opacity = '1';
        draggedElement.style.transform = '';
        draggedElement.style.zIndex = '';
        
        container.insertBefore(draggedElement, placeholder);
        placeholder.remove();
        
        draggedElement = null;
        placeholder = null;
        
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', handleDrop);
      }
      
      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable-card:not([style*="opacity: 0.5"])')];
        
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }
    }
    
    // Global function to close split view
    window.closeSplitView = function() {
      if (window.currentSplitView) {
        window.currentSplitView.remove();
        window.originalGrid.style.display = 'grid';
        // Remove viewing-report class to restore title and dropdown
        document.body.classList.remove('viewing-report');
        window.currentSplitView = null;
        window.originalGrid = null;
      }
      
      // Remove fixed report title
      if (window.currentReportTitle) {
        window.currentReportTitle.remove();
        window.currentReportTitle = null;
      }
    };

    // Report item menu functions
    function toggleReportItemMenu(itemIndex) {
      const dropdown = document.getElementById(`reportItemDropdown${itemIndex}`);
      if (!dropdown) return;
      
      // Close all other dropdowns
      document.querySelectorAll('.report-item-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
      });
      
      // Toggle this dropdown
      dropdown.classList.toggle('show');
    }

    function removeFromReport(itemIndex) {
      console.log('removeFromReport called with index:', itemIndex);
      
      if (!confirm('Are you sure you want to remove this item from the report?')) {
        return;
      }
      
      // Get current report ID from URL or stored state
      const currentReportId = getCurrentReportId();
      console.log('Current report ID:', currentReportId);
      
      const report = userReports.find(r => r.id === currentReportId);
      console.log('Found report:', report);
      
      if (!report || !report.items || itemIndex >= report.items.length) {
        console.error('Cannot remove item:', { report, itemIndex, itemsLength: report?.items?.length });
        alert('Error: Could not find item to remove');
        return;
      }
      
      console.log('Removing item at index', itemIndex, 'from', report.items.length, 'items');
      
      // Remove the item
      const removedItem = report.items.splice(itemIndex, 1);
      console.log('Removed item:', removedItem);
      
      // Update timestamp
      report.updatedAt = new Date().toISOString();
      
      // Save to localStorage  
      try {
        localStorage.setItem('userReports', JSON.stringify(userReports));
        console.log('Saved to localStorage successfully');
      } catch (error) {
        console.error('Failed to save to localStorage:', error);
        alert('Error saving changes');
        return;
      }
      
      // Close the dropdown
      document.querySelectorAll('.report-item-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
      
      // Refresh the report view
      console.log('Refreshing report view');
      viewReport(currentReportId);
      
      // Show success message
      alert('Item removed from report successfully');
    }

    function addToAnotherReport(itemIndex) {
      console.log('addToAnotherReport called with index:', itemIndex);
      
      // Get current report ID and find the item
      const currentReportId = getCurrentReportId();
      console.log('Current report ID:', currentReportId);
      
      const report = userReports.find(r => r.id === currentReportId);
      console.log('Found report:', report);
      
      if (!report || !report.items || itemIndex >= report.items.length) {
        console.error('Cannot find item to copy:', { report, itemIndex, itemsLength: report?.items?.length });
        alert('Error: Could not find item to copy');
        return;
      }
      
      const itemToCopy = report.items[itemIndex];
      console.log('Item to copy:', itemToCopy);
      
      // Close the dropdown first
      document.querySelectorAll('.report-item-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
      
      // Create modal for selecting target report
      showAddToAnotherReportModal(itemToCopy);
    }

    function getCurrentReportId() {
      // You might store this differently - adjust as needed
      // This assumes we store it when viewing a report
      return window.currentReportId;
    }

    function showAddToAnotherReportModal(item) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      `;
      
      // Get other reports (exclude current one)
      const currentReportId = getCurrentReportId();
      const otherReports = userReports.filter(r => r.id !== currentReportId);
      
      modal.innerHTML = `
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">Add to Another Report</h3>
        <div style="margin-bottom: 16px;">
          <button id="createNewReportFromItem" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #D14829;
            background: #D14829;
            color: white;
            border-radius: 8px;
            font-weight: 500;
            margin-bottom: 12px;
            cursor: pointer;
          ">+ Create New Report</button>
        </div>
        <div id="existingReportsFromItem" style="max-height: 200px; overflow-y: auto;">
          ${otherReports.length === 0 ? '<p style="color: #666; font-size: 14px; margin: 0;">No other reports found.</p>' : 
            otherReports.map(report => `
              <button onclick="addItemToExistingReport('${report.id}', this)" style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                background: white;
                border-radius: 6px;
                text-align: left;
                margin-bottom: 8px;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">
                <div style="font-weight: 500;">${escapeHtml(report.title)}</div>
                <div style="font-size: 12px; color: #666;">${report.items?.length || 0} items</div>
              </button>
            `).join('')}
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button id="cancelItemModal" style="
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
          ">Cancel</button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Store item data for access by other functions
      window.itemToAdd = item;
      
      // Event listeners
      document.getElementById('createNewReportFromItem').onclick = () => {
        const reportTitle = prompt('Enter new report title:');
        if (!reportTitle) return;
        
        createNewReportWithItem(reportTitle, item);
        document.body.removeChild(overlay);
      };
      
      document.getElementById('cancelItemModal').onclick = () => {
        document.body.removeChild(overlay);
      };
      
      overlay.onclick = (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      };
    }

    function addItemToExistingReport(reportId, button) {
      console.log('addItemToExistingReport called with reportId:', reportId);
      
      const item = window.itemToAdd;
      if (!item) {
        console.error('No item data found');
        alert('Error: No item data found');
        return;
      }
      
      console.log('Item to add:', item);
      
      const targetReport = userReports.find(r => r.id === reportId);
      if (!targetReport) {
        console.error('Target report not found:', reportId);
        alert('Error: Target report not found');
        return;
      }
      
      console.log('Target report found:', targetReport.title);
      
      // Add item to target report
      if (!targetReport.items) targetReport.items = [];
      
      const newItem = {
        ...item,
        timestamp: new Date().toISOString()
      };
      
      targetReport.items.push(newItem);
      targetReport.updatedAt = new Date().toISOString();
      
      console.log('Added item to report. New item count:', targetReport.items.length);
      
      // Save to localStorage
      try {
        localStorage.setItem('userReports', JSON.stringify(userReports));
        console.log('Saved to localStorage successfully');
      } catch (error) {
        console.error('Failed to save to localStorage:', error);
        alert('Error saving changes');
        return;
      }
      
      // Close modal
      const overlay = button.closest('[style*="position: fixed"]');
      if (overlay) {
        document.body.removeChild(overlay);
      } else {
        // Fallback - find any modal overlay
        const overlays = document.querySelectorAll('[style*="position: fixed"]');
        overlays.forEach(o => {
          if (o.style.zIndex === '10000') {
            document.body.removeChild(o);
          }
        });
      }
      
      // Show success message
      alert(`Item added to "${targetReport.title}" successfully!`);
    }

    function createNewReportWithItem(title, item) {
      console.log('createNewReportWithItem called:', title, item);
      
      const newReport = {
        id: Date.now().toString(),
        title: title,
        description: '',
        items: [{
          ...item,
          timestamp: new Date().toISOString()
        }],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      userReports.push(newReport);
      
      try {
        localStorage.setItem('userReports', JSON.stringify(userReports));
        console.log('New report saved to localStorage successfully');
      } catch (error) {
        console.error('Failed to save new report:', error);
        alert('Error creating report');
        return;
      }
      
      alert(`New report "${title}" created with this item!`);
    }

    // Store current report ID when viewing a report
    function setCurrentReportId(reportId) {
      window.currentReportId = reportId;
    }

    // Report header menu functions
    function toggleReportHeaderMenu() {
      const dropdown = document.getElementById('reportHeaderDropdown');
      if (!dropdown) return;
      
      // Close all other dropdowns
      document.querySelectorAll('.report-item-dropdown').forEach(d => {
        d.classList.remove('show');
      });
      
      // Toggle header dropdown
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }

    function renameReport(reportId) {
      console.log('renameReport called with ID:', reportId);
      
      const report = userReports.find(r => r.id === reportId);
      if (!report) {
        alert('Error: Report not found');
        return;
      }
      
      const currentTitle = report.title || 'Untitled Report';
      const newTitle = prompt(`Enter new name for report:`, currentTitle);
      
      if (!newTitle || newTitle.trim() === '') {
        return; // User cancelled or entered empty title
      }
      
      if (newTitle.trim() === currentTitle) {
        return; // No change needed
      }
      
      // Update the report title
      report.title = newTitle.trim();
      report.updatedAt = new Date().toISOString();
      
      // Save to localStorage
      try {
        localStorage.setItem('userReports', JSON.stringify(userReports));
        console.log('Report renamed and saved successfully');
      } catch (error) {
        console.error('Failed to save renamed report:', error);
        alert('Error saving report name change');
        return;
      }
      
      // Close the dropdown
      const dropdown = document.getElementById('reportHeaderDropdown');
      if (dropdown) dropdown.style.display = 'none';
      
      // Update the displayed title
      const titleElement = document.querySelector('.fixed-report-title h1');
      if (titleElement) {
        titleElement.textContent = newTitle.trim();
      }
      
      // Show success message
      alert(`Report renamed to "${newTitle.trim()}" successfully!`);
    }

    // Generate report layout with orange cards stacked and white cards side by side
    function generateReportLayout(items) {
      if (!Array.isArray(items) || items.length === 0) {
        return '<p style="text-align: center; color: #6b7280; padding: 40px;">No items in this report</p>';
      }
      
      // Separate orange (answer) cards and white (theme) cards
      const orangeCards = [];
      const whiteCards = [];
      
      items.forEach((item, index) => {
        const isOrangeCard = item.html && (
          item.html.includes('answer-card') || 
          item.html.includes('background: #D14829') ||
          item.html.includes('background: var(--jaice-orange')
        );
        
        const cardData = { item, index };
        
        if (isOrangeCard) {
          orangeCards.push(cardData);
        } else {
          whiteCards.push(cardData);
        }
      });
      
      let html = '<div style="display: block; width: 100%;">';
      
      // Add orange cards FIRST (one per row, stacked) - ALWAYS full width, never side by side
      if (orangeCards.length > 0) {
        html += '<div style="width: 100%; margin-bottom: 20px;">'; // Orange cards container
        orangeCards.forEach(({ item, index }) => {
          html += `
            <div class="report-item orange-card" draggable="true" data-index="${index}" style="width: 100%; max-width: 100%; display: block; margin-bottom: 20px; clear: both; float: none; cursor: move;">
              <div class="report-item-menu">
                <button class="report-item-menu-button" onclick="toggleReportItemMenu(${index})">â‹¯</button>
                <div class="report-item-dropdown" id="reportItemDropdown${index}">
                  <button onclick="removeFromReport(${index})">Remove from Report</button>
                  <button onclick="addToAnotherReport(${index})">Add to Another Report</button>
                </div>
              </div>
              <div class="report-item-content">
                ${cleanItemContent(item.html || item.content || '<div>No content available</div>')}
              </div>
            </div>
          `;
        });
        html += '</div>'; // Close orange cards container
      }
      
      // Add white cards AFTER orange cards (two per row, side by side)
      if (whiteCards.length > 0) {
        html += '<div style="width: 100%; clear: both;">'; // White cards container
        html += '<div style="display: flex; flex-direction: column; gap: 20px;">';
        
        for (let i = 0; i < whiteCards.length; i += 2) {
          const isLastCardAlone = (i + 1 >= whiteCards.length); // Check if this is the last card with no pair
          
          html += '<div style="display: flex; gap: 20px; width: 100%;">';
          
          // First card in the row
          const card1 = whiteCards[i];
          const card1Style = isLastCardAlone ? "width: 100%;" : "flex: 1; min-width: 0;"; // Full width if alone
          html += `
            <div class="report-item white-card" draggable="true" data-index="${card1.index}" style="${card1Style} cursor: move;">
              <div class="report-item-menu">
                <button class="report-item-menu-button" onclick="toggleReportItemMenu(${card1.index})">â‹¯</button>
                <div class="report-item-dropdown" id="reportItemDropdown${card1.index}">
                  <button onclick="removeFromReport(${card1.index})">Remove from Report</button>
                  <button onclick="addToAnotherReport(${card1.index})">Add to Another Report</button>
                </div>
              </div>
              <div class="report-item-content">
                ${cleanItemContent(card1.item.html || card1.item.content || '<div>No content available</div>')}
              </div>
            </div>
          `;
          
          // Second card in the row (if exists)
          if (i + 1 < whiteCards.length) {
            const card2 = whiteCards[i + 1];
            html += `
              <div class="report-item white-card" draggable="true" data-index="${card2.index}" style="flex: 1; min-width: 0; cursor: move;">
                <div class="report-item-menu">
                  <button class="report-item-menu-button" onclick="toggleReportItemMenu(${card2.index})">â‹¯</button>
                  <div class="report-item-dropdown" id="reportItemDropdown${card2.index}">
                    <button onclick="removeFromReport(${card2.index})">Remove from Report</button>
                    <button onclick="addToAnotherReport(${card2.index})">Add to Another Report</button>
                  </div>
                </div>
                <div class="report-item-content">
                  ${cleanItemContent(card2.item.html || card2.item.content || '<div>No content available</div>')}
                </div>
              </div>
            `;
          }
          // Note: No empty space div needed - single cards now take full width
          
          html += '</div>';
        }
        
        html += '</div>'; // Close flex column container
        html += '</div>'; // Close white cards container
      }
      
      html += '</div>';
      return html;
    }
    
    function toggleSidebar() {
      document.body.classList.toggle('sidebar-collapsed');
      const toggleBtn = document.querySelector('.sidebar-toggle');
      if (document.body.classList.contains('sidebar-collapsed')) {
        toggleBtn.innerHTML = 'â†’ Show Menu';
      } else {
        toggleBtn.innerHTML = 'â˜° Menu';
      }
    }
    
    let reportChanged = false;
    
    function showSaveButton() {
      if (!reportChanged) {
        reportChanged = true;
        document.querySelector('.save-report-btn').classList.add('show');
      }
    }
    
    function saveReport() {
      // Save report logic here
      console.log('Saving report...');
      reportChanged = false;
      document.querySelector('.save-report-btn').classList.remove('show');
      
      // Show confirmation
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.textContent = 'Report saved successfully!';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Watch for changes to show save button
    document.addEventListener('DOMContentLoaded', function() {
      // Watch for card deletions and layout changes
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
            showSaveButton();
          }
        });
      });
      
      const reportGrid = document.getElementById('reportGrid');
      if (reportGrid) {
        observer.observe(reportGrid, { childList: true, subtree: true });
      }
    });

    // Make functions globally accessible
    window.toggleReportItemMenu = toggleReportItemMenu;
    window.removeFromReport = removeFromReport;
    window.addToAnotherReport = addToAnotherReport;
    window.addItemToExistingReport = addItemToExistingReport;
    window.toggleReportHeaderMenu = toggleReportHeaderMenu;
    window.renameReport = renameReport;
    window.generateReportLayout = generateReportLayout;
    
    async function duplicateReport(reportId) {
      const report = userReports.find(r => r.id === reportId);
      if (!report) return;
      
      try {
        const response = await fetch('/api/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ 
            title: report.title + ' (Copy)', 
            description: report.description 
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        await loadReportsFromAPI();
        showToast('Report duplicated successfully!');
      } catch (error) {
        console.error('Failed to duplicate report:', error);
        alert('Failed to duplicate report');
      }
    }
    
    function exportReport(reportId) {
      const report = userReports.find(r => r.id === reportId);
      if (!report) return;
      showToast(`PDF export for "${report.title}" would be generated here.`);
    }
    
    async function deleteReport(reportId) {
      const report = userReports.find(r => r.id === reportId);
      if (!report) return;
      
      if (!confirm(`Delete "${report.title}"? This cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/reports/${encodeURIComponent(reportId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        await loadReportsFromAPI();
        showToast(`Report "${report.title}" deleted.`);
      } catch (error) {
        console.error('Failed to delete report:', error);
        alert('Failed to delete report');
      }
    }

    // Toast helper
    function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 80px; right: 24px; background: var(--white);
        border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px;
        box-shadow: var(--shadow-medium); z-index: 1001; max-width: 400px;
        font-size: 14px; font-weight: 500; color: var(--text-primary); animation: slideInRight 0.3s ease;`;
      toast.textContent = message; 
      document.body.appendChild(toast);
      setTimeout(() => { 
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => { 
          if (toast.parentNode) toast.parentNode.removeChild(toast); 
        }, 300);
      }, 3000);
    }
    
    // Toast animations
    (function addToastAnimations(){
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        
        /* Dashboard card styles for proper formatting */
        .dashboard-item {
          background: var(--white, #ffffff);
          border: 1px solid var(--border, #e0e4e7);
          border-radius: 16px;
          padding: 16px;
          box-shadow: var(--shadow-soft, 0 1px 3px rgba(0,0,0,0.1));
          position: relative;
          font-size: 14px;
          transition: all 0.2s ease;
        }
        
        .dashboard-item:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-medium, 0 4px 12px rgba(0,0,0,0.15));
        }
        
        .dashboard-item h4 {
          margin: 0 0 6px 0;
          font-size: 16px;
          font-weight: 600;
          color: var(--text-primary, #1f2937);
          border-bottom: 1px solid var(--jaice-orange, #D14829);
          padding-bottom: 6px;
          margin-bottom: 8px;
          text-align: left;
        }
        
        .chart-description {
          font-size: 16px;
          color: var(--text-muted, #6b7280);
          line-height: 1.5;
          margin-bottom: 8px;
          text-align: left;
        }
        
        .chart-content {
          margin-top: 8px;
        }
        
        .chart-wrapper {
          margin: 8px 0;
          background: transparent;
          border-radius: 0;
          padding: 0;
        }
        
        .bullets {
          margin: 8px 0;
          padding-left: 16px;
        }
        
        .bullets li {
          margin-bottom: 4px;
          line-height: 1.5;
          color: var(--text-primary, #1f2937);
          font-size: 16px;
        }
        
        .quote-section {
          margin: 8px 0;
        }
        
        .quote-item {
          margin: 6px 0;
          padding: 0;
          background: transparent;
          border-left: none;
          border-radius: 0;
          font-style: italic;
          color: #666;
          font-size: 16px;
        }
        
        .quote-text {
          margin-bottom: 8px;
          line-height: 1.5;
        }
        
        .quote-speaker {
          font-size: 13px;
          color: #888;
          font-weight: 500;
        }
        
        .card-header-with-menu {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
          position: relative;
        }
        
        /* Answer card styles for consistency */
        .answer-card {
          background: rgba(209, 72, 41, 0.05);
          border: 1px solid #D14829;
          border-left: 4px solid var(--jaice-orange);
          color: var(--text-primary);
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          margin-bottom: 16px;
        }
        
        .answer-headline {
          font-size: 18px;
          font-weight: 700;
          margin-bottom: 4px;
          line-height: 1.3;
          border-bottom: 1px solid var(--jaice-orange, #D14829);
          padding-bottom: 6px;
        }
        
        .answer-details {
          font-size: 16px;
          line-height: 1.5;
          opacity: 0.95;
        }
        
        /* Fix report item alignment and container sizing */
        .report-item {
          display: block !important;
          align-items: flex-start !important;
          justify-content: flex-start !important;
          text-align: left !important;
          background: transparent !important;
          border: none !important;
          padding: 0 !important;
          position: relative;
          width: 100%;
          box-sizing: border-box;
        }
        
        /* Specific orange card styling to match home page and ensure proper stacking */
        .report-item.orange-card {
          width: 100% !important;
          display: block !important;
          flex: none !important;
          margin-bottom: 12px;
          clear: both;
        }
        
        .report-item.orange-card .answer-card {
          background: rgba(209, 72, 41, 0.05) !important;
          border: 1px solid #D14829 !important;
          border-left: 4px solid var(--jaice-orange) !important;
          color: var(--text-primary) !important;
          padding: 16px !important;
          font-size: 20px !important;
        }
        
        /* Ensure all text in orange cards matches white card font sizes */
        .report-item.orange-card .answer-headline,
        .report-item.orange-card .answer-title {
          border-bottom: 1px solid var(--jaice-orange, #D14829) !important;
          padding-bottom: 6px !important;
          margin-bottom: 4px !important;
        }
        
        
        /* Force orange cards to never be side by side */
        .report-item.orange-card {
          width: 100% !important;
          max-width: 100% !important;
          flex: none !important;
          display: block !important;
          float: none !important;
          clear: both !important;
        }
        
        /* Aggressive font-size ONLY overrides to double text size while preserving all other formatting */
        .report-grid *:not(.permanent-drop-zone) {
          font-size: 12px !important; /* Default double of common 6px */
        }
        
        /* More specific overrides for common text sizes */
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 4px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 4pt"] {
          font-size: 8px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 5px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 5pt"] {
          font-size: 10px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 6px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 6pt"] {
          font-size: 12px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 7px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 7pt"] {
          font-size: 14px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 8px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 8pt"] {
          font-size: 16px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 9px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 9pt"] {
          font-size: 18px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 10px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 10pt"] {
          font-size: 20px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 12px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 12pt"] {
          font-size: 24px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 14px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 14pt"] {
          font-size: 28px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 16px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 16pt"] {
          font-size: 32px !important;
        }
        
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 18px"],
        .report-grid *:not(.permanent-drop-zone)[style*="font-size: 18pt"] {
          font-size: 36px !important;
        }
        
        /* Dashboard items get slightly larger base */
        .report-grid .dashboard-item {
          font-size: 16px !important;
        }
        
        .report-grid .dashboard-item h4 {
          font-size: 20px !important;
        }
        
        .report-item-content {
          text-align: left !important;
          width: 100%;
          position: relative;
          box-sizing: border-box;
        }
        
        /* Fix split view layout and prevent horizontal overflow */
        .report-view-container {
          width: 100%;
          max-width: none;
          overflow: visible;
          box-sizing: border-box;
        }
        
        .report-grid {
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
          overflow: visible;
        }
        
        /* Ensure main content doesn't create horizontal scroll */
        .content {
          overflow-x: hidden !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Force all potential overflow containers to behave */
        * {
          box-sizing: border-box;
        }
        
        body, html {
          overflow-x: hidden !important;
          width: 100% !important;
          max-width: 100% !important;
        }
        
        
        /* Three-dot menu for report items */
        .report-item-menu {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 20;
        }
        
        .report-item-menu-button {
          background: #f3f4f6;
          border: 1px solid #d1d5db;
          border-radius: 4px;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          opacity: 0;
          transition: opacity 0.2s;
          font-size: 14px;
          color: #6b7280;
        }
        
        .report-item:hover .report-item-menu-button {
          opacity: 1;
        }
        
        .report-item-dropdown {
          display: none;
          position: absolute;
          top: 100%;
          right: 0;
          background: white;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          min-width: 180px;
          z-index: 1000;
          padding: 4px 0;
        }
        
        .report-item-dropdown.show {
          display: block;
        }
        
        .report-item-dropdown button {
          display: block;
          width: 100%;
          text-align: left;
          padding: 8px 12px;
          border: none;
          background: white;
          cursor: pointer;
          font-size: 14px;
          color: #374151;
          transition: background-color 0.2s;
        }
        
        .report-item-dropdown button:hover {
          background-color: #f3f4f6;
        }
        
        .report-item-dropdown button.danger {
          color: #dc2626;
        }
        
        .report-item-dropdown button.danger:hover {
          background-color: #fef2f2;
        }`;
      document.head.appendChild(style);
    })();

    // Utils
    function escapeHtml(text) { 
      const div = document.createElement('div'); 
      div.textContent = text ?? ''; 
      return div.innerHTML; 
    }
    
    function cleanItemContent(html) {
      if (!html) return '<div>No content available</div>';
      
      // Create a temporary div to manipulate the HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      
      // ONLY remove the three-dot menu containers and their dropdowns
      // Keep everything else exactly as is
      const menuContainers = tempDiv.querySelectorAll('.dropdown-container');
      menuContainers.forEach(container => {
        container.remove();
      });
      
      // Also remove any standalone dropdown menus
      const dropdowns = tempDiv.querySelectorAll('.dropdown-menu');
      dropdowns.forEach(dropdown => {
        dropdown.remove();
      });
      
      // Double all font sizes while preserving all other formatting
      const allElementsWithFontSize = tempDiv.querySelectorAll('*');
      allElementsWithFontSize.forEach(element => {
        const styles = element.style;
        if (styles.fontSize) {
          const currentSize = styles.fontSize;
          let newSize;
          
          if (currentSize.includes('px')) {
            const pixels = parseFloat(currentSize);
            newSize = (pixels * 2) + 'px';
          } else if (currentSize.includes('pt')) {
            const points = parseFloat(currentSize);
            newSize = (points * 2) + 'pt';
          } else if (currentSize.includes('em')) {
            const ems = parseFloat(currentSize);
            newSize = (ems * 2) + 'em';
          } else if (currentSize.includes('rem')) {
            const rems = parseFloat(currentSize);
            newSize = (rems * 2) + 'rem';
          } else if (currentSize.includes('%')) {
            const percent = parseFloat(currentSize);
            newSize = (percent * 2) + '%';
          } else {
            // For unitless numbers, assume px
            const number = parseFloat(currentSize);
            if (!isNaN(number)) {
              newSize = (number * 2) + 'px';
            }
          }
          
          if (newSize) {
            element.style.fontSize = newSize;
          }
        }
      });
      
      return tempDiv.innerHTML;
    }
    
    function stripHtml(html) { 
      const div = document.createElement('div'); 
      div.innerHTML = html ?? ''; 
      return div.textContent || div.innerText || ''; 
    }
    
    function truncateText(text, maxLength) { 
      if ((text ?? '').length <= maxLength) return text ?? ''; 
      return (text ?? '').slice(0, maxLength) + '...'; 
    }

    // Helper function to truncate HTML content
    function truncateHtml(html, maxLength) {
      if (!html) return '';
      const div = document.createElement('div');
      div.innerHTML = html;
      const text = div.textContent || div.innerText || '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    // Drag and Drop Functionality for Modular Reports
    function initializeReportDragDrop() {
      const grid = document.getElementById('reportGrid');
      if (!grid) return;
      
      let draggedElement = null;
      let placeholder = null;
      
      // Add drag event listeners to all report items
      grid.querySelectorAll('.report-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
      });
      
      // Add permanent drop zones that are always visible
      addPermanentDropZones();
      
      function addPermanentDropZones() {
        // Add drop zone at the very top
        const topZone = document.createElement('div');
        topZone.className = 'permanent-drop-zone';
        topZone.textContent = 'Drop here to move to top';
        topZone.style.cssText = `
          margin: 5px 0;
          min-height: 25px;
          opacity: 0;
          background: rgba(209,72,41,0.1);
          border: 1px dashed rgba(209,72,41,0.4);
          border-radius: 6px;
          display: none;
          align-items: center;
          justify-content: center;
          color: #D14829;
          font-size: 14px;
          transition: all 0.2s;
          pointer-events: none;
        `;
        
        topZone.addEventListener('dragenter', (e) => {
          e.preventDefault();
          e.stopPropagation();
          topZone.style.opacity = '1';
          topZone.style.backgroundColor = 'rgba(209,72,41,0.15)';
        });
        
        topZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
        
        topZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // Only reset if not dragging to a child element
          if (!topZone.contains(e.relatedTarget)) {
            topZone.style.opacity = '0.7';
            topZone.style.backgroundColor = 'rgba(209,72,41,0.1)';
          }
        });
        
        topZone.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (draggedElement) {
            // Insert at the very beginning, after this zone
            if (topZone.nextSibling) {
              grid.insertBefore(draggedElement, topZone.nextSibling);
            } else {
              grid.appendChild(draggedElement);
            }
            updateReportOrder();
          }
        });
        
        grid.insertBefore(topZone, grid.firstChild);
        
        // Add drop zone at the very bottom
        const bottomZone = document.createElement('div');
        bottomZone.className = 'permanent-drop-zone';
        bottomZone.textContent = 'Drop here to move to bottom';
        bottomZone.style.cssText = topZone.style.cssText;
        
        bottomZone.addEventListener('dragenter', (e) => {
          e.preventDefault();
          e.stopPropagation();
          bottomZone.style.opacity = '1';
          bottomZone.style.backgroundColor = 'rgba(209,72,41,0.15)';
        });
        
        bottomZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
        
        bottomZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!bottomZone.contains(e.relatedTarget)) {
            bottomZone.style.opacity = '0.7';
            bottomZone.style.backgroundColor = 'rgba(209,72,41,0.1)';
          }
        });
        
        bottomZone.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (draggedElement) {
            grid.appendChild(draggedElement);
            updateReportOrder();
          }
        });
        
        grid.appendChild(bottomZone);
      }
      
      function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        
        // Create placeholder for smooth reordering
        placeholder = document.createElement('div');
        placeholder.className = 'drop-zone active';
        placeholder.textContent = 'Drop here';
        
        // Show and activate permanent drop zones during drag
        document.querySelectorAll('.permanent-drop-zone').forEach(zone => {
          zone.style.display = 'flex';
          zone.style.opacity = '0.7';
          zone.style.pointerEvents = 'auto';
        });
      }
      
      function handleDragEnd(e) {
        this.classList.remove('dragging');
        if (placeholder && placeholder.parentNode) {
          placeholder.remove();
        }
        
        // Hide permanent drop zones after drag ends
        document.querySelectorAll('.permanent-drop-zone').forEach(zone => {
          zone.style.display = 'none';
          zone.style.opacity = '0';
          zone.style.pointerEvents = 'none';
        });
        
        draggedElement = null;
        placeholder = null;
      }
      
      function handleDragOver(e) {
        e.preventDefault();
        
        if (draggedElement === this) return;
        if (this.classList.contains('permanent-drop-zone')) return;
        
        // Insert placeholder before or after current item for smooth reordering
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (e.clientY < midY) {
          this.parentNode.insertBefore(placeholder, this);
        } else {
          this.parentNode.insertBefore(placeholder, this.nextSibling);
        }
      }
      
      function handleDrop(e) {
        e.preventDefault();
        
        if (placeholder && placeholder.parentNode && draggedElement) {
          // Move the dragged element
          placeholder.parentNode.insertBefore(draggedElement, placeholder);
          placeholder.remove();
          
          // Update the report order
          updateReportOrder();
        }
      }
      
      function updateReportOrder() {
        // Get all items in their new order
        const items = Array.from(grid.querySelectorAll('.report-item'));
        const reportItems = items.map(item => {
          const index = parseInt(item.dataset.index);
          const report = userReports.find(r => r.id === currentReportId);
          return report ? report.items[index] : null;
        }).filter(Boolean);
        
        // Update the report data
        const report = userReports.find(r => r.id === currentReportId);
        if (report) {
          report.items = reportItems;
          localStorage.setItem('userReports', JSON.stringify(userReports));
          
          // Regenerate the entire layout to fix width issues
          setTimeout(() => {
            const reportGrid = document.getElementById('reportGrid');
            if (reportGrid) {
              reportGrid.innerHTML = generateReportLayout(report.items);
              
              // Force font size override after regeneration
              setTimeout(() => {
                const allElements = reportGrid.querySelectorAll('*');
                allElements.forEach(element => {
                  const currentStyle = element.style.fontSize;
                  if (currentStyle) {
                    let newSize;
                    if (currentStyle.includes('px')) {
                      const pixels = parseFloat(currentStyle);
                      newSize = (pixels * 2) + 'px';
                    } else if (currentStyle.includes('pt')) {
                      const points = parseFloat(currentStyle);
                      newSize = (points * 2) + 'pt';
                    } else if (currentStyle.includes('em')) {
                      const ems = parseFloat(currentStyle);
                      newSize = (ems * 2) + 'em';
                    } else {
                      const number = parseFloat(currentStyle);
                      if (!isNaN(number)) {
                        newSize = (number * 2) + 'px';
                      }
                    }
                    if (newSize) {
                      element.style.setProperty('font-size', newSize, 'important');
                    }
                  } else if (!currentStyle) {
                    element.style.setProperty('font-size', '12px', 'important');
                  }
                });
              }, 50);
              
              // Re-initialize drag and drop with small delay to ensure DOM is ready
              setTimeout(() => {
                initializeReportDragDrop();
              }, 100);
            }
          }, 100);
        }
      }
    }

    // Expose handlers to global scope
    window.toggleReportMenu = toggleReportMenu;
    window.viewReport = viewReport;
    window.duplicateReport = duplicateReport;
    window.exportReport = exportReport;
    window.deleteReport = deleteReport;
    window.showCreateReportModal = showCreateReportModal;
    window.loadReportsFromAPI = loadReportsFromAPI;
  
    function applyReportWidthDefaults() {
      try {
        const grid = document.getElementById('reportGrid');
        if (!grid) return;
        // Force responsive 12-col grid at runtime to beat any stale CSS
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(12, minmax(0, 1fr))';
        grid.style.gap = '20px';

        // Normalize widths of cards created from saved HTML
        const nodes = grid.querySelectorAll('.draggable-card, .report-item-card, .response-card, .answer-card, .dashboard-item');
        nodes.forEach(el => {
          const isAnswer = el.classList.contains('answer-card') || el.classList.contains('response-card');
          const isDash = el.classList.contains('dashboard-item');
          
          const target = el.classList.contains('draggable-card') ? el : (el.closest('.draggable-card') || el);

          // Stretch element
          target.style.width = '100%';
          target.style.maxWidth = '100%';
          
          if (isAnswer) {
            // Orange card: full row
            target.classList.add('full-width');
            target.style.gridColumn = '1 / -1';
          } else if (isDash) {
            // White card: half by default
            target.classList.add('half-width');
            if (!target.style.gridColumn) target.style.gridColumn = 'span 6';
          }
        });
      } catch (e) {
        console.warn('applyReportWidthDefaults error', e);
      }
    }
    

function scrubInlineWidths(root) {
  try {
    if (!root) return;
    const nodes = root.querySelectorAll('[style]');
    nodes.forEach(n => {
      const s = n.getAttribute('style') || '';
      if (/max-width|width|min-width/.test(s)) {
        n.style.setProperty('max-width', '100%', 'important');
        n.style.setProperty('width', 'auto', 'important');
        n.style.setProperty('min-width', '0', 'important');
      }
      // remove any transform scaling that might be stuck
      if (/(transform\s*:)/i.test(s)) {
        n.style.setProperty('transform', 'none', 'important');
      }
    });
  } catch(e) { console.warn('scrubInlineWidths error', e); }
}

</script>

  <!-- Load reports integration -->
  <script src="/reports-integration.js"></script>
  <script src="/jaice-fixes.js"></script>
  
</body>
</html>